# Residual Covariance Structures {#sec-me-rcs .unnumbered}

## Misc {#sec-me-rcs-misc .unnumbered}

-   Notes from
    -   [Mixed Models with R \>\> Common Extensions \>\> Residual Structures](https://m-clark.github.io/mixed-models-with-R/extensions.html#residual-structure)
-   The issue is that the way lmer works by default employs a method that won’t allow it incorporate other covariance structures(this is why it is faster and better performing than other packages).
    -   However many other packages work with lme4 model results, but not nlme, and if you aren’t going to use lme4 for mixed models you might as well go Bayesian with rstanarm or brms instead of nlme.
    -   Even prefers mgcv to nlme because of the other capabilities it provides, and the model objects created are easier to work
-   observations closer in time would be more strongly correlated than those further apart, or that the variance changes over time
-   mixed anova assumption is sphericity.

## Matrix Structures {#sec-me-rcs-matstr .unnumbered}

-   The overall variance-covariance matrix is made up of submatrices for each subject
    -   [Example]{.ribbon-highlight}: Varying Intercepts Model\
        ![](_resources/Mixed-Effects-RCS.resources/struct-vcov-overall-vi-1.svg){.lightbox width="532"}
        -   Shows 5 subjects — each with 6 observations.
        -   Within the person, there are variances on the diagonal and covariances of observations on the off-diagonal
        -   Observations from one person have no covariance with another person (light gray area)
        -   This is supposed to be from the GPA data model ([link](https://m-clark.github.io/mixed-models-with-R/random_intercepts.html#application)).
            -   Going by the numbers from the results of that model, the diagonal (orange) is the total variance (Between + Within-Subject).
            -   The off-diagonal values is the Between-Subject intercept variance
-   Compound Symmetry\
    $$
    \Sigma = 
    \begin{bmatrix}
    \sigma^2 & \rho  & \rho \\
    \rho & \sigma^2 & \rho \\
    \rho & \rho & \sigma^2
    \end{bmatrix}
    $$
    -   Structure the typical mixed effects model
    -   Sphericity is a relaxed form of compound symmetry, where all (subjects?) the correlations have the same value, i.e. $\rho_1 = \rho_2 = \rho_3$, and all variances are equal.
-   Heterogeneous Variance\
    $$
    \Sigma = 
    \begin{bmatrix}
    \sigma_1^2 & 0 & 0 \\
    0 & \sigma_2^2 & 0 \\
    0 & 0 & \sigma_3^2
    \end{bmatrix}
    $$
    -   Each measure for each subject has an estimated variance and those are constant for each subject.
    -   My current understanding is that this is between-subject variance.
    -   For example, $\sigma_1^2$ is the variance between each subject's first observation.
-   Unstructured (or Symmetric) Correlation\
    $$
    \Sigma = 
    \begin{bmatrix}
    \sigma^2 & \rho_1 & \rho_2 \\
    \rho_1 & \sigma^2 & \rho_3 \\
    \rho_2 & \rho_3 & \sigma^2
    \end{bmatrix}
    $$
-   Autocorrelation\
    $$
    \Sigma = 
    \begin{bmatrix}
    \sigma^2 & \rho & \rho^2 & \rho^3 \\
    \rho & \sigma^2 & \rho & \rho^2 \\
    \rho^2 & \rho & \sigma^2 & \rho \\
    \rho^3 & \rho^2 & \rho & \sigma^2 \\
    \end{bmatrix}
    $$

## Examples {#sec-me-rcs-ex .unnumbered}

-   Heterogeneous Variance
    -   [Example 1]{.ribbon-highlight}: [{glmmTMB}]{style="color: #990000"}

        -   Data

            <Details>

            <Summary>Code</Summary>

            ``` r
            dplyr::glimpse(gpa)
            #> Rows: 1,200
            #> Columns: 10
            #> $ student  <fct> 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 7, 7, 7, …
            #> $ occas    <fct> year 1 semester 1, year 1 semester 2, year 2 semester 1, year 2 semester 2, year 3 semester 1, year 3 semester 2, yea…
            #> $ gpa      <dbl> 2.3, 2.1, 3.0, 3.0, 3.0, 3.3, 2.2, 2.5, 2.6, 2.6, 3.0, 2.8, 2.4, 2.9, 3.0, 2.8, 3.3, 3.4, 2.5, 2.7, 2.4, 2.7, 2.9, 2.…
            #> $ job      <fct> 2 hours, 2 hours, 2 hours, 2 hours, 2 hours, 2 hours, 2 hours, 3 hours, 2 hours, 2 hours, 2 hours, 2 hours, 2 hours, …
            #> $ sex      <fct> female, female, female, female, female, female, male, male, male, male, male, male, female, female, female, female, f…
            #> $ highgpa  <dbl> 2.8, 2.8, 2.8, 2.8, 2.8, 2.8, 2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 3.8, 3.8, 3.8, 3.8, 3.8, 3.…
            #> $ admitted <fct> yes, yes, yes, yes, yes, yes, no, no, no, no, no, no, yes, yes, yes, yes, yes, yes, no, no, no, no, no, no, yes, yes,…
            #> $ year     <dbl> 1, 1, 2, 2, 3, 3, 1, 1, 2, 2, 3, 3, 1, 1, 2, 2, 3, 3, 1, 1, 2, 2, 3, 3, 1, 1, 2, 2, 3, 3, 1, 1, 2, 2, 3, 3, 1, 1, 2, …
            #> $ semester <fct> 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, …
            #> $ occasion <dbl> 0, 1, 2, 3, 4, 5, 0, 1, 2, 3, 4, 5, 0, 1, 2, 3, 4, 5, 0, 1, 2, 3, 4, 5, 0, 1, 2, 3, 4, 5, 0, 1, 2, 3, 4, 5, 0, 1, 2, …
            ```

            </Details>

        -   Model

            ``` r
            library(glmmTMB)

            mod_gpa_vi_hetvar <- 
              glmmTMB(
                gpa ~ occasion 
                      + (1 | student) 
                      + diag(0 + occas | student), 
                data = gpa
              )

            summary(mod_gpa_vi_hetvar)
            #> Random effects:
            #> 
            #> Conditional model:
            #>  Groups    Name                   Variance Std.Dev. Corr                     
            #>  student   (Intercept)            0.093123 0.30516                           
            #>  student.1 occasyear 1 semester 1 0.129833 0.36032                           
            #>            occasyear 1 semester 2 0.086087 0.29341  0.00                     
            #>            occasyear 2 semester 1 0.046240 0.21503  0.00 0.00                
            #>            occasyear 2 semester 2 0.017615 0.13272  0.00 0.00 0.00           
            #>            occasyear 3 semester 1 0.008709 0.09332  0.00 0.00 0.00 0.00      
            #>            occasyear 3 semester 2 0.017730 0.13316  0.00 0.00 0.00 0.00 0.00 
            #>  Residual                         0.008065 0.08980                           
            #> Number of obs: 1200, groups:  student, 200
            #> 
            #> Dispersion estimate for gaussian family (sigma^2): 0.00806 
            #> 
            #> Conditional model:
            #>             Estimate Std. Error z value Pr(>|z|)    
            #> (Intercept) 2.598788   0.026201   99.19   <2e-16 ***
            #> occasion    0.106141   0.004034   26.31   <2e-16 ***
            ```

            -   `diag` specifies the covariance structure
            -   [occasion]{.var-text} is essentially the observation id variable for each [student]{.var-text}
                -   The numeric variable, [occasion]{.var-text}, is used as a fixed effect and the factor variable, [occas]{.var-text}, is used covariance specification.
            -   Each [student]{.var-text} has six observations, so there are six variances for each one.
            -   `VarCorr(mod_gpa_vi_hetvar)$cond$student.1` extracts heterogeneous variances
            -   The variances decrease over time which would indicate that student GPAs become more similar over time.
            -   [Dispersion estimate for gaussian family]{.arg-text} is just the Residual variance (see Random Effects section of the summary)
                -   For other distributions, it's the dispersion (e.g. Poisson)
-   Autocorrelation
    -   [Example 1]{.ribbon-highlight}: [{glmmTMB}]{style="color: #990000"}

        ``` r
        mod_gpa_vi_auto <- 
          glmmTMB(
            gpa ~ occasion 
                  + (1 | student)
                  + ar1(0 + occas | student),
            data = gpa
          )

        summary(mod_gpa_vi_auto)
        #> Random effects:
        #> 
        #> Conditional model:
        #>  Groups    Name                   Variance  Std.Dev.  Corr      
        #>  student   (Intercept)            3.384e-10 0.0000184           
        #>  student.1 occasyear 1 semester 1 9.283e-02 0.3046760 0.84 (ar1)
        #>  Residual                         2.791e-02 0.1670688           
        #> Number of obs: 1200, groups:  student, 200
        #> 
        #> Dispersion estimate for gaussian family (sigma^2): 0.0279 
        #> 
        #> Conditional model:
        #>             Estimate Std. Error z value Pr(>|z|)    
        #> (Intercept) 2.597577   0.023385  111.08   <2e-16 ***
        #> occasion    0.106875   0.005493   19.46   <2e-16 ***
        ```

        -   See Hetergeneous Example 1 for a description of the data

        -   `ar1` specifies the autocorrelation structure.

        -   Finding the [ar1]{.arg-text} correlation in order to extract it is ridiculous

            ``` r
            corr_obj <- VarCorr(mod_gpa_vi_auto)$cond$student.1
            attr(corr_obj, "correlation")[1,2]
            #> [1] 0.8441728

            # or

            mixedup::extract_cor_structure(mod_gpa_vi_auto, which_cor = "ar1")
            #>   parameter student.1
            #>   <chr>         <dbl>
            #> 1 ar1           0.844
            ```

            -   Remember that in an autocorrelation structure, the correlation values are just powers of one $\rho$ value and that value will be at the [\[1, 2\]]{.arg-text} and [\[2, 1\]]{.arg-text} coordinates. (See [Matrix Structures](mixed-effects-residual-covar.qmd#sec-me-rcs-matstr){style="color: green"} \>\> Autocorrelation)
