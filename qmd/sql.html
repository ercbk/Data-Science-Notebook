<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SQL – Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../qmd/stochastic-processes.html" rel="next">
<link href="../qmd/spreadsheets.html" rel="prev">
<link href="../images/ds-favicon-32.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../qmd/sql.html">SQL</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Data Science</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://ericbook.netlify.app/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-house"></i></a>
    <a href="https://ercbk.github.io/Domain-Knowledge-Notebook/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-lightbulb"></i></a>
    <a href="https://ercbk.github.io/Statistical-Rethinking-Notebook/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-book"></i></a>
    <a href="https://github.com/ercbk/Data-Science-Notebook" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Algorithms</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/algorithms-learn-to-rank.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Learn-to-Rank</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/algorithms-marketing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Marketing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/algorithms-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">ML</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/algorithms-product.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Product</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/algorithms-recommendation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Recommendation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/anomaly-detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Anomaly Detection</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Apache</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/apache-arrow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Arrow</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/apache-spark.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spark</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/apis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">APIs</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Association</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/association-copulas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Copulas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/association-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/association-time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/aws.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AWS</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Bayes</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/bayes-priors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Priors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/bayes-reporting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reporting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/bayes-troubleshooting-hmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Troubleshooting HMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/bayes-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Workflow</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/big-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Big Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/business-plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Business Plots</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/causal-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Causal Inference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classification</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">CLI</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/cli-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/cli-linux.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linux</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/cli-windows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Windows</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/cloud-services.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cloud Services</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Clustering</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/clustering-time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/clustering-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Code</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/code-debug.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Debugging</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/code-optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/code-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Review</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/code-style-guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Style Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/code-testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/confidence-and-prediction-intervals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Confidence &amp; Prediction Intervals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/cross-validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cross-Validation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">CSS</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/css-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/css-recipes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Recipes</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">Databases</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-dbt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">dbt</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-duckdb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DuckDB</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Engineering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-feature-stores.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Feature Stores</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-lakes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lakes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modeling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-normalization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Normalization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-nosql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NoSQL</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-postgres.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Postgres</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-relational.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Relational</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-vector.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vector Databases</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/db-warehouses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Warehouses</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/decision-intelligence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decision Intelligence</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">Diagnostics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-bayes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clustering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-cv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CV</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-dl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DL</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-forecasting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Forecasting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-glm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GLM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-mixed-effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixed Effects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-model-agnostic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Agnostic</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-nlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NLP</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-probabilistic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/diagnostics-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/distributions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributions</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false">
 <span class="menu-text">Deep Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dl-audio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Audio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dl-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dl-graph.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graph</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dl-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dl-tabular.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tabular</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/dl-training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false">
 <span class="menu-text">Docker</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/docker-aws.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AWS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/docker-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Docker, Fundamentals</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/docker-misc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Misc</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false">
 <span class="menu-text">Econometrics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/econometrics-discrete-choice-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discrete Choice Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/econometrics-fixed-effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fixed Effects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/econometrics-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/econometrics-psa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Propensity Score Analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="false">
 <span class="menu-text">EDA</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/eda-geospatial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geospatial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/eda-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/eda-multilevel-longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multilevel, Longitudinal</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/eda-text.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/eda-time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false">
 <span class="menu-text">Experiments</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-15" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/experiments-a_b-testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A/B Testing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/experiments-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/experiments-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Designs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/experiments-planning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Planning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/experiments-rct.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RCT</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/experiments-stepped-wedge-cluster-design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stepped Wedge Cluster Design</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/extreme-value-theory-(evt).html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Extreme Value Theory</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="false">
 <span class="menu-text">Feature Engineering</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-16" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-engineering-embeddings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-engineering-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-engineering-geospatial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geospatial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-engineering-time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-engineering-splines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Splines</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-engineering-tokenization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tokenization</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" role="navigation" aria-expanded="false">
 <span class="menu-text">Feature Reduction</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-17" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-reduction-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-reduction-time-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Time Series</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/feature-selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Feature Selection</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false">
 <span class="menu-text">Forecasting</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-18" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-decomposition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decomposition</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-dl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deep Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-ensembling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ensembling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-hierarchical_grouped.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hierarchical/Grouped</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ML</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-multivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multivariate</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-nonlinear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nonlinear</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/forecasting-statistical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/generalized-additive-models-(gam).html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generalized Additive Models</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" role="navigation" aria-expanded="false">
 <span class="menu-text">Geospatial</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-19" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/geospatial-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/geospatial-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/geospatial-remote-sensing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Remote Sensing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/geospatial-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preprocessing</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-20" role="navigation" aria-expanded="false">
 <span class="menu-text">Git</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-20" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-20" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/git-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/git-github-actions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Github Actions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/glossary-ds-terms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Glossary: DS terms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/gnu-make.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GNU Make</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-21" role="navigation" aria-expanded="false">
 <span class="menu-text">Google</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-21" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-21" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/google-analytics-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analytics, Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/google-analytics-reports.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analytics, Reports</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/google-bigquery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BigQuery</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/html.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HTML</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-22" role="navigation" aria-expanded="false">
 <span class="menu-text">IDEs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-22" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-22" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/ide-jupyter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Jupyter</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/ide-rstudio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/ide-vscode.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">VS Code</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/information-theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Information Theory</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/inkscape.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Inkscape</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-23" role="navigation" aria-expanded="false">
 <span class="menu-text">Job</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-23" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-23" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/job-management-leadership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Management / Leadership</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/job-on-the-job.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">On the job</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/job-organizational-and-team-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Organizational and Team Development</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/job-reports.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reports</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/job-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Search</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-24" role="navigation" aria-expanded="false">
 <span class="menu-text">Javascript</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-24" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-24" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/js-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/js-observable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Observable</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/json.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JSON</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/kubernetes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Kubernetes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/latex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LaTeX</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-25" role="navigation" aria-expanded="false">
 <span class="menu-text">LLMs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-25" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-25" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/llms-agent-chains.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Agent Chains</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/llms-fine-tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fine Tuning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/llms-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/llms-prompt-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prompt Engineering</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/loss-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Loss Functions</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-26" role="navigation" aria-expanded="false">
 <span class="menu-text">Mathematics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-26" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-26" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mathematics-linear-algebra.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Algebra</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mathematics-glossary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Glossary</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mathematics-notation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Notation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mathematics-probability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Probability</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mathematics-statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/misc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Misc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/missingness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Missingness</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-27" role="navigation" aria-expanded="false">
 <span class="menu-text">Mixed Effects</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-27" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-27" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mixed-effects-bmlr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">BMLR</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mixed-effects-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mixed-effects-glmm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GLMM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mixed-effects-residual-covar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Residual Covariance Structures</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/mlops.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MLOps</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-28" role="navigation" aria-expanded="false">
 <span class="menu-text">Model Building</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-28" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-28" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-brms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">brms</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Concepts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-ensembling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ensembling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-h2o-automl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">H2O AutoML</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-modeltime.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">modeltime</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-rstanarm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">rstanarm</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-sklearn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">sklearn</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/model-building-tidymodels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">tidymodels</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-29" role="navigation" aria-expanded="false">
 <span class="menu-text">Networks</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-29" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-29" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/networks-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/networks-knowledge-graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Knowledge Graphs</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-30" role="navigation" aria-expanded="false">
 <span class="menu-text">NLP</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-30" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-30" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/nlp-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/nlp-sentiment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sentiment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/nlp-summarization-extraction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Summarization and Extraction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/nlp-topic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Topic</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/nlp-transformers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformers</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/optimization-equation-systems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/outliers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Outliers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/package-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Package Development</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-31" role="navigation" aria-expanded="false">
 <span class="menu-text">Post-Hoc Analysis</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-31" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-31" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/post-hoc-analysis-ab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A/B</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/post-hoc-analysis-anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ANOVA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/post-hoc-analysis-emmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">emmeans</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/post-hoc-analysis-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/post-hoc-analysis-multilevel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multilevel</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/privacy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Privacy/Security</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-32" role="navigation" aria-expanded="false">
 <span class="menu-text">Production</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-32" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-32" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/production-data-validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Validation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/production-deployment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deployment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/production-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Development</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/production-ml-monitoring.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">ML Monitoring</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/production-testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/production-tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tools</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-33" role="navigation" aria-expanded="false">
 <span class="menu-text">Projects</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-33" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-33" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/project-analyses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analyses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/project-development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Development</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/project-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Management</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/project-planning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Planning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-34" role="navigation" aria-expanded="false">
 <span class="menu-text">Python</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-34" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-34" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-classes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-misc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Misc</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-numpy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Numpy</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-pandas-recipes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas, Recipes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-pandas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-polars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Polars</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-reticulate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">reticulate</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/python-snippets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Snippets</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/quarto-rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-35" role="navigation" aria-expanded="false">
 <span class="menu-text">R</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-35" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-35" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/r-base-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Base R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/r-data-table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">data.table</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/r-polars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Polars</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/r-snippets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Snippets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/r-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tidyverse</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regex</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-36" role="navigation" aria-expanded="false">
 <span class="menu-text">Regression</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-36" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-36" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-discrete.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discrete</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-interactions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interactions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-linear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-logistic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-multinomial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multinomial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-multivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multivariate</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-ordinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ordinal</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-quantile.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quantile</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-regularized.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regularized</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/regression-survival.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Survival</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/renv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Renv</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/scraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scraping</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-37" role="navigation" aria-expanded="false">
 <span class="menu-text">Shiny</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-37" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-37" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-hosting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hosting</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-mobile.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mobile</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-modules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modules</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-production.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Production</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-ui.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">UI</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/shiny-ui-examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">UI Examples</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/simulation-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation, Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/spreadsheets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spreadsheets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/sql.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">SQL</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/stochastic-processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stochastic Processes</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-38" role="navigation" aria-expanded="false">
 <span class="menu-text">Surveys</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-38" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-38" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/surveys-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/surveys-census-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Census Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/surveys-design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/surveys-sampling-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampling Methods</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/teaching.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Teaching</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/tidyeval.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tidyeval</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tuning</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-39" role="navigation" aria-expanded="false">
 <span class="menu-text">Visualization</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-39" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-39" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/visualization-general.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/visualization-ggplot2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/visualization-gtable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">gtable</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/visualization-diagrams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diagrams</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/visualization-mixed-effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixed Effects</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-40" role="navigation" aria-expanded="false">
 <span class="menu-text">Web</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-40" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-40" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/web-design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Web Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/web-servers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Server</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-sql-misc" id="toc-sec-sql-misc" class="nav-link active" data-scroll-target="#sec-sql-misc">Misc</a></li>
  <li><a href="#sec-sql-setup" id="toc-sec-sql-setup" class="nav-link" data-scroll-target="#sec-sql-setup">Set-up</a></li>
  <li><a href="#sec-sql-terms" id="toc-sec-sql-terms" class="nav-link" data-scroll-target="#sec-sql-terms">Terms</a></li>
  <li><a href="#sec-sql-basics" id="toc-sec-sql-basics" class="nav-link" data-scroll-target="#sec-sql-basics">Basics</a>
  <ul>
  <li><a href="#sec-sql-basics-misc" id="toc-sec-sql-basics-misc" class="nav-link" data-scroll-target="#sec-sql-basics-misc">Misc</a></li>
  <li><a href="#sec-sql-basics-ctabs" id="toc-sec-sql-basics-ctabs" class="nav-link" data-scroll-target="#sec-sql-basics-ctabs">Create Tables</a></li>
  <li><a href="#sec-sql-basics-add" id="toc-sec-sql-basics-add" class="nav-link" data-scroll-target="#sec-sql-basics-add">Add Data</a></li>
  <li><a href="#update-table" id="toc-update-table" class="nav-link" data-scroll-target="#update-table">Update Table</a></li>
  <li><a href="#sec-sql-basics-del" id="toc-sec-sql-basics-del" class="nav-link" data-scroll-target="#sec-sql-basics-del">Delete Rows</a></li>
  <li><a href="#sec-sql-basics-subq" id="toc-sec-sql-basics-subq" class="nav-link" data-scroll-target="#sec-sql-basics-subq">Subqueries</a></li>
  <li><a href="#sec-sql-basics-joins" id="toc-sec-sql-basics-joins" class="nav-link" data-scroll-target="#sec-sql-basics-joins">Joins</a></li>
  </ul></li>
  <li><a href="#sec-sql-r" id="toc-sec-sql-r" class="nav-link" data-scroll-target="#sec-sql-r">R</a>
  <ul>
  <li><a href="#sec-sql-r-misc" id="toc-sec-sql-r-misc" class="nav-link" data-scroll-target="#sec-sql-r-misc">Misc</a></li>
  <li><a href="#sec-sql-r-dbplyr" id="toc-sec-sql-r-dbplyr" class="nav-link" data-scroll-target="#sec-sql-r-dbplyr"><span style="color: #990000">{dbplyr}</span></a></li>
  <li><a href="#sec-sql-r-dbi" id="toc-sec-sql-r-dbi" class="nav-link" data-scroll-target="#sec-sql-r-dbi"><span style="color: #990000">{DBI}</span></a></li>
  <li><a href="#sec-sql-r-prql" id="toc-sec-sql-r-prql" class="nav-link" data-scroll-target="#sec-sql-r-prql">PRQL</a></li>
  <li><a href="#sec-sql-r-dm" id="toc-sec-sql-r-dm" class="nav-link" data-scroll-target="#sec-sql-r-dm"><span style="color: #990000">{dm}</span></a></li>
  </ul></li>
  <li><a href="#sec-sql-bestp" id="toc-sec-sql-bestp" class="nav-link" data-scroll-target="#sec-sql-bestp">Best Practices</a></li>
  <li><a href="#sec-sql-index" id="toc-sec-sql-index" class="nav-link" data-scroll-target="#sec-sql-index">Indexes</a></li>
  <li><a href="#sec-sql-part" id="toc-sec-sql-part" class="nav-link" data-scroll-target="#sec-sql-part">Partitioning</a></li>
  <li><a href="#sec-sql-views" id="toc-sec-sql-views" class="nav-link" data-scroll-target="#sec-sql-views">Views</a></li>
  <li><a href="#sec-sql-vars" id="toc-sec-sql-vars" class="nav-link" data-scroll-target="#sec-sql-vars">Variables</a></li>
  <li><a href="#sec-sql-funs" id="toc-sec-sql-funs" class="nav-link" data-scroll-target="#sec-sql-funs">Functions</a></li>
  <li><a href="#sec-sql-udfs" id="toc-sec-sql-udfs" class="nav-link" data-scroll-target="#sec-sql-udfs">User Defined Functions (UDF)</a></li>
  <li><a href="#sec-sql-loops" id="toc-sec-sql-loops" class="nav-link" data-scroll-target="#sec-sql-loops">Loops</a></li>
  <li><a href="#sec-sql-winfun" id="toc-sec-sql-winfun" class="nav-link" data-scroll-target="#sec-sql-winfun">Window Functions</a></li>
  <li><a href="#sec-sql-ctes" id="toc-sec-sql-ctes" class="nav-link" data-scroll-target="#sec-sql-ctes">Common Table Expressions (CTE)</a></li>
  <li><a href="#sec-sql-str" id="toc-sec-sql-str" class="nav-link" data-scroll-target="#sec-sql-str">Strings</a></li>
  <li><a href="#sec-sql-arr" id="toc-sec-sql-arr" class="nav-link" data-scroll-target="#sec-sql-arr">Arrays</a></li>
  <li><a href="#sec-sql-bizq" id="toc-sec-sql-bizq" class="nav-link" data-scroll-target="#sec-sql-bizq">Business Queries</a></li>
  <li><a href="#sec-sql-trans" id="toc-sec-sql-trans" class="nav-link" data-scroll-target="#sec-sql-trans">Transactions</a></li>
  <li><a href="#sec-sql-procexp" id="toc-sec-sql-procexp" class="nav-link" data-scroll-target="#sec-sql-procexp">Processing Expressions</a>
  <ul>
  <li><a href="#sec-sql-procexp-nulls" id="toc-sec-sql-procexp-nulls" class="nav-link" data-scroll-target="#sec-sql-procexp-nulls">NULLs</a></li>
  <li><a href="#sec-sql-procexp-dups" id="toc-sec-sql-procexp-dups" class="nav-link" data-scroll-target="#sec-sql-procexp-dups">Duplicated Rows</a></li>
  <li><a href="#sec-sql-procexp-nest" id="toc-sec-sql-procexp-nest" class="nav-link" data-scroll-target="#sec-sql-procexp-nest">Nested Data</a></li>
  <li><a href="#sec-sql-procexp-bin" id="toc-sec-sql-procexp-bin" class="nav-link" data-scroll-target="#sec-sql-procexp-bin">Binning</a></li>
  <li><a href="#sec-sql-procexp-ts" id="toc-sec-sql-procexp-ts" class="nav-link" data-scroll-target="#sec-sql-procexp-ts">Time Series</a></li>
  </ul></li>
  <li><a href="#sec-sql-tools" id="toc-sec-sql-tools" class="nav-link" data-scroll-target="#sec-sql-tools">Tools</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-sql" class="quarto-section-identifier">SQL</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-sql-misc" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-misc">Misc</h2>
<ul>
<li><p>Resources</p>
<ul>
<li><a href="https://databases.pacha.dev/">Publicly Available SQL Databases</a>: Need to email administrator to gain access</li>
<li><a href="https://gvwilson.github.io/sql-tutorial/">SQL for Data Scientists in 100 Queries</a>
<ul>
<li>SQLite, administrative commands, query commands, JSON ops, python</li>
</ul></li>
</ul></li>
<li><p><code>dplyr::show_query</code> can convert a dplyr expression to SQL for db object (e.g.&nbsp;dbplyr,&nbsp; duckdb, arrow)</p></li>
<li><p>Queries in examples</p>
<ul>
<li>Window Functions
<ul>
<li>Average Salary by Job Title</li>
<li>Average Unit Price for each CustomerId</li>
<li>Rank customers by amount spent</li>
<li>Create a new column that ranks Unit Price in descending order for each CustomerId</li>
<li>Create a new column that provides the previous order date’s Quantity for each ProductId</li>
<li>Create a new column that provides the very first Quantity ever ordered for each ProductId</li>
<li>Calculate a cumulative moving average UnitPrice for each CustomerId</li>
<li>Rank customers for each department by amount spent</li>
<li>Find the model and year of the car that been on the lot the longest</li>
<li>Create a subset (CTE)
<ul>
<li>Calculate a running monthly total (aka cumsum)
<ul>
<li>Also running average</li>
</ul></li>
<li>Calculate a running monthly total for each account id</li>
<li>Calculate a 3 months rolling running total using a window that includes the current month.</li>
<li>Calculate a 7 months rolling running total using a window where the current month is always the middle month</li>
<li>Calculate the number of consecutive days spent in each country</li>
</ul></li>
</ul></li>
<li>CTE
<ul>
<li>Average monthly cost per campaign for the company’s marketing efforts</li>
<li>Count the number of interactions of new users</li>
<li>The average top Math test score for students in California</li>
</ul></li>
<li>Business Queries
<ul>
<li>7-day Simple Moving Average (SMA)</li>
<li>Rank product categories by shipping cost for each shipping address</li>
<li>Total order quantity for each month</li>
<li>Monthly and yearly total orders and average shipping costs</li>
<li>Daily counts of open jobs (where “open” is an untracked daily status)</li>
<li>Get the latest order from each customer</li>
<li>Overall median price</li>
<li>Median price for each product</li>
<li>Overall median price and quantity</li>
</ul></li>
<li>Processing Expressions
<ul>
<li>Provide subtotals for a hierarchical group of fields (e.g.&nbsp;family, category, subcategory)
<ul>
<li>See NULLs &gt;&gt; COALESCE</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Order of Operations<br>
<a href="./_resources/SQL.resources/1-MCyFDF35OZ3n0dyZqX6_Tw.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="./_resources/SQL.resources/1-MCyFDF35OZ3n0dyZqX6_Tw.png" class="img-fluid" width="370"></a></p>
<ul>
<li>Higher ranked functions can be inserted inside lower ranked functions
<ul>
<li>e.g a window function can be inside a SELECT function but not inside a WHERE clause</li>
<li>There are exceptions and hacks around this in some cases</li>
</ul></li>
</ul></li>
<li><p>Types of Commands</p>
<ul>
<li>Data Query Language (DQL) - used to find and view data without making any permanent changes to the database.</li>
<li>Data Manipulation Language (DML) - used to make permanent changes to the data, such as updating values or deleting them.</li>
<li>Data Definition Language (DDL) - used to make permanent changes to the table, such as creating or deleting a table.</li>
<li>Data Control Language (DCL) - used for administrative commands, such as adding or removing users of different tables and databases.</li>
<li>Transact Control Language (TCL) - advanced SQL that deals with transaction level statements.</li>
</ul></li>
<li><p>Microsoft SQL Server format for referencing a table:</p>
<ul>
<li><p>[database].[schema].[tablename]</p></li>
<li><p>Alternative</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">USE</span> my_data_base</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>GO</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-setup" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-setup">Set-up</h2>
<ul>
<li>postgres
<ul>
<li><a href="https://www.postgresql.org/download/">Download</a> postgres</li>
<li><a href="https://www.pgadmin.org/download/">pgAdmin</a> is an IDE commonly used with postgres
<ul>
<li>Open pgAdmin and click on “Add new server.”
<ul>
<li>Sets up connection to existing server so make sure postgres is installed beforehand</li>
</ul></li>
<li>Create Tables
<ul>
<li>home &gt;&gt; Databases (1) &gt;&gt; postgres &gt;&gt; Query Tool</li>
</ul></li>
<li>If needed, give <a href="https://stackoverflow.com/questions/14083311/permission-denied-when-trying-to-import-a-csv-file-from-pgadmin">permission</a> to pgAdmin to access data from a folder
<ul>
<li>Might be necessary to upload csv files</li>
</ul></li>
<li>Import csv file
<ul>
<li>right-click the table name &gt;&gt; Import/Export</li>
<li>Options tab
<ul>
<li>Select import, add file path to File Name, choose csv for format, select Yes for Header, add , for Delimiter</li>
</ul></li>
<li>Columns tab
<ul>
<li>uncheck columns not in the csv (probably the primary key)
<ul>
<li>Wonder if NULLs will be automatically inserted for columns in the table that aren’t in the file.</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://www.postgresql.org/docs/current/app-psql.html">psql</a> - PostgreSQL interactive terminal. Allows you to script and automate tasks, e.g.&nbsp;tests, check errors, and do data entry on the command line.
<ul>
<li><a href="https://tomcam.github.io/postgres/">Cheatsheet</a></li>
<li>Requires
<ol type="1">
<li>The user name and password for your PostgreSQL database</li>
<li>The IP address of your remote instance if working remotely</li>
</ol></li>
<li>The <span class="arg-text">db=#</span> prompt indicates the command line interface (CLI) prompt. Here’s a breakdown of what each part means:
<ul>
<li><span class="arg-text">db</span>: This is the name of the current database to which you are connected.</li>
<li><span class="arg-text">=#</span>: This is the prompt symbol that appears when you are logged in as a superuser (like postgres). If you were logged in as a regular user, the prompt would be <span class="arg-text">=&gt;</span></li>
<li><span class="ribbon-highlight">Example</span>:
<ul>
<li><p>Input</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">db</span><span class="op">=#</span> <span class="kw">CREATE</span> <span class="kw">TABLE</span> tags (</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">id</span> <span class="dt">INT</span> <span class="kw">GENERATED</span> <span class="kw">BY</span> <span class="kw">DEFAULT</span> <span class="kw">AS</span> <span class="kw">IDENTITY</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">name</span> <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Output</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The way psql indicates the command was successful is by confusingly printing the command.</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-terms" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-terms">Terms</h2>
<ul>
<li><span style="color: #009499"><strong>Batch</strong></span> - a set of sql statements e.g.&nbsp;statements between BEGIN and END</li>
<li><span style="color: #009499"><strong>Compiled object</strong></span> - you can create a function written in C/C++ and load into the database (at least in postgres) to achieve high performance.</li>
<li><span style="color: #009499"><strong>Correlated Columns</strong></span> - tells how good the match between logical and physical ordering is.</li>
<li><span style="color: #009499"><strong>Correlated/Uncorrelated</strong> <strong>Subqueries</strong></span>
<ul>
<li><p>correlated- a type of query, where inner query depends upon the outcome of the outer query in order to perform its execution</p>
<ul>
<li>A correlated subquery can be thought of as a filter on the table that it refers to, as if the subquery were evaluated on each row of the table in the outer query<br>
</li>
</ul></li>
<li><p>uncorrelated - a type of sub-query where inner query doesn’t depend upon the outer query for its execution.</p>
<ul>
<li>It is an independent query, the results of which are returned to and used by the outer query once (not per row).</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Uncorrelated subquery:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- inner query, c1, only depends on table2</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> c1, c2</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">from</span> table1 <span class="kw">where</span> c1 <span class="op">=</span> (<span class="kw">select</span> <span class="fu">max</span>(x) <span class="kw">from</span> table2);</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Correlated subquery:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- inner query, c1, depends on table1 and table2</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> c1, c2</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">from</span> table1 <span class="kw">where</span> c1 <span class="op">=</span> (<span class="kw">select</span> x <span class="kw">from</span> table2 <span class="kw">where</span> y <span class="op">=</span> table1.c2);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><span style="color: #009499"><strong>Functions</strong></span> - Execute at a different level of priority and are handled differently than Views. You will likely see better performance.</li>
<li><span style="color: #009499"><strong>Idempotent</strong></span> - Providing the same input should always produce the same output, e.g.&nbsp;A plain <code>INSERT</code> is not idempotent because executing the command with the same input for the second time will trigger an error.</li>
<li><span style="color: #009499"><strong>Index</strong></span> - A quick lookup table (e.g.&nbsp;field or set of fields) for finding records users need to search frequently. An index is small, fast, and optimized for quick lookups. It is very useful for connecting the relational tables and searching large tables. (also see <a href="../qmd/db-engineering.html#sec-db-eng-costopt">DB, Engineering</a> &gt;&gt; Cost Optimizations)</li>
<li><span style="color: #009499"><strong>Migrations (schema)</strong></span> - A version control system for your database schema. Management of incremental, reversible changes and version control to relational database schemas. A schema migration is performed on a database whenever it is necessary to update or revert that database’s schema to some newer or older version.</li>
<li><span style="color: #009499"><strong>Physical Ordering</strong></span> - A PostgreSQL table consists of one or more files of 8KB blocks (or “pages”). The order in which the rows are stored in the file is the physical ordering.</li>
<li><span style="color: #009499"><strong>Predicate</strong></span> - Defines a logical condition being applied to rows in a table. (e.g.&nbsp;IN, EXISTS, BETWEEEN, LIKE, ALL, ANY)</li>
<li><span style="color: #009499"><strong>Scalar/Non-Scalar Subqueries</strong></span>
<ul>
<li>A scalar subquery returns a single value (one column of one row). If no rows qualify to be returned, the subquery returns NULL.</li>
<li>A non-scalar subquery returns 0, 1, or multiple rows, each of which may contain 1 or multiple columns. For each column, if there is no value to return, the subquery returns NULL. If no rows qualify to be returned, the subquery returns 0 rows (not NULLs).</li>
</ul></li>
<li><span style="color: #009499"><strong>Selectivity</strong></span> - The fraction of rows in a table or partition that is chosen by the predicate
<ul>
<li>Refers to the quality of a filter in its ability to reduce the number of rows that will need to be examined and ultimately returned
<ul>
<li>With a high selectivity, using the primary key or indexes to get right to the rows of interest</li>
<li>With a low selectivity, a full table scan would likely be needed to get the rows of interest.</li>
</ul></li>
<li>Higher selectivity means: more unique data; fewer duplicates; fewer number of rows for each key value</li>
<li>Used to estimate the cost of a particular access method; it is also used to determine the optimal join order. A poor choice of join order by the optimizer could result in a very expensive execution plan.</li>
</ul></li>
<li><span style="color: #009499"><strong>Soft-deleted</strong></span> - An operation in which a flag is used to mark data as unusable, without erasing the data itself from the database</li>
<li><span style="color: #009499"><strong>Surrogate key</strong></span> - Very similar to a primary key in that it is a unique value for an object in a table. However, rather than being derived from actual data present in the table, it is a field generated by the object itself. It has no business value like a primary key does, but is rather only used for data analysis purposes. Can be generated using different columns that already exist in your table or more often from two or more tables. <a href="https://github.com/dbt-labs/dbt-utils#surrogate_key-source">dbt function definition</a>
<ul>
<li>Examples: PostgreSQL serial column, Oracle sequence column, or MySQL auto_increment column, Snowflake _file + _line columns</li>
<li>Example: Each employee id is concatenated with a department id (e.g.&nbsp;marketing or finance)<br>
<a href="./_resources/SQL.resources/1-upKcdpMyn4wxcKk8wuHj4A.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="./_resources/SQL.resources/1-upKcdpMyn4wxcKk8wuHj4A.png" class="img-fluid" width="470"></a></li>
</ul></li>
<li><span style="color: #009499"><strong>Transaction</strong></span> - A set of queries tied together such that if one query fails, the entire set of queries are rolled back to a pre-query state if the situation dictates.
<ul>
<li>A database transaction, by definition, must be atomic, consistent, isolated and durable. These are popularly known as <strong>ACID</strong> properties.&nbsp; These properties can ensure the concurrent execution of multiple transactions without conflict.</li>
</ul></li>
<li><span style="color: #009499"><strong>Views</strong></span> - Database objects that represent saved SELECT queries in “virtual” tables.
<ul>
<li>Contains a query plan. &nbsp;For each query executed, the planner has to evaluate what’s being asked and calculate an optimal path. Views already have this plan calculated so it allows subsequent queries to be returned with almost no friction in processing aside from data retrieval.</li>
<li>Some views are updateable but under certain conditions (1-1 mapping of rows in view to underlying table, no group_by, etc.)</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-basics" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-basics">Basics</h2>
<section id="sec-sql-basics-misc" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-basics-misc">Misc</h3>
<ul>
<li><code>DROP TABLE &lt;table name&gt;</code> - Deletes table from database. Used to remove obsolete or redundant tables from the database.</li>
<li>Comments
<ul>
<li><p>Single Line</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Select all:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> Customers;</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> Customers <span class="co">-- WHERE City='Berlin';</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Any text between <code>--</code> and the end of the line will be ignored (will not be executed)</li>
</ul></li>
<li><p>Multi-Line</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*Select all the columns</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">of all the records</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">in the Customers table:*/</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> Customers;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-basics-ctabs" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-basics-ctabs">Create Tables</h3>
<ul>
<li><p>If you don’t include the schema as part of the table name (e.g.&nbsp;schema_name.table_name), pgadmin automatically places it into the “public” schema directory</p></li>
<li><p>Field Syntax: name, data type, constraints</p></li>
<li><p><span class="ribbon-highlight">Example</span>: Create table as select (CTAS)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> new_table AS&nbsp;</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>&nbsp;</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> old_table&nbsp;</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> condition;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: Table 1 (w/primary key)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> classrooms <span class="kw">CASCADE</span>;</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> classrooms (</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">GENERATED</span> ALWAYS <span class="kw">AS</span> IDENTITY,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; teacher <span class="dt">VARCHAR</span>(<span class="dv">100</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; );</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a> <span class="co">-- OR</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> classrooms (&nbsp;</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">id</span> <span class="dt">INT</span> <span class="kw">GENERATED</span> ALWAYS <span class="kw">AS</span> IDENTITY,&nbsp;</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; teacher <span class="dt">VARCHAR</span>(<span class="dv">100</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>)&nbsp;</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; );&nbsp; &nbsp;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>“classrooms” is the name of the table; “id” and “teacher” are the fields</p></li>
<li><p><code>CASCADE</code> - postgres won’t delete the table if other tables point to it, so cascade will override measure.</p></li>
<li><p><code>GENERATED ALWAYS AS IDENTITY</code> - makes it so you don’t have to keep track of which “id” values have been used when adding rows. You can ommit the value for “id” and just add the values for the other fields</p>
<ul>
<li>Also seen <code>id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY</code></li>
</ul></li>
<li><p>See <a href="https://www.postgresqltutorial.com/postgresql-identity-column/">tutorial</a> for options, usage, removing, adding, etc. this constraint</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> classrooms</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (teacher)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="st">'Mary'</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="st">'Jonah'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Also see Add Data &gt;&gt; Example: chatGPT</li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Table 2 (w/foreign key)</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> students <span class="kw">CASCADE</span>;</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> students (</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">GENERATED</span> ALWAYS <span class="kw">AS</span> IDENTITY,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; name <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; classroom_id <span class="dt">INT</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">CONSTRAINT</span> fk_classrooms</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    &nbsp; &nbsp; <span class="kw">FOREIGN</span> <span class="kw">KEY</span>(classroom_id)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">REFERENCES</span> classrooms(<span class="kw">id</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“students” is the name of the table; “id”, “name”, and “classroom_id” are the fields</li>
<li>Create a foreign key that points to the “classrooms” table
<ul>
<li><p>Expression</p>
<ul>
<li>fk_classrooms is the name of the <code>CONSTRAINT</code></li>
<li>“classroom_id” is the field that will be the <code>FOREIGN KEY</code></li>
<li><code>REFERENCES</code> points the foreign key to the classrooms table’s primary key, “id”
<ul>
<li>foreign keys can point to any table</li>
</ul></li>
</ul></li>
<li><p>Postgres won’t allow you to insert a row into students with a “classroom_id” that doesn’t exist in the “id” field of classrooms but will allow you to use a NULL placeholder</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Explicitly specify NULL</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> students</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (name, classroom_id)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="st">'Dina'</span>, <span class="kw">NULL</span>);&nbsp;</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- Implicitly specify NULL</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> students</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (name)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="st">'Evan'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Also see Add Data &gt;&gt; Example: chatGPT</li>
</ul></li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> members (</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">id</span> serial <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; second_name <span class="dt">character</span> <span class="dt">varying</span>(<span class="dv">200</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; date_joined <span class="dt">date</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="fu">current_date</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; member_id <span class="dt">integer</span> <span class="kw">references</span> members(<span class="kw">id</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; booking_start_time <span class="dt">timestamp</span> <span class="kw">without</span> timezone <span class="kw">NOT</span> <span class="kw">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The “serial” data type does the same thing as <code>GENERATED ALWAYS AS IDENTITY</code> (see first example), but is NOT compliant with the SQL standard. Use <code>GENERATED ALWAYS AS IDENTITY</code></li>
<li>“references” seems to be another old way to create foreign keys (see 2nd example for proper way)</li>
<li>“character varying” - variable-length with limit (e.g limit of 200 characters)
<ul>
<li>character(n), char(n) are for fixed character lengths; text is for unlimited character lengths</li>
</ul></li>
<li>“current_date” is a function that will insert the current date as a value</li>
<li>“timestamp without timezone” is literally that
<ul>
<li>also available: time with/without timezone, date, interval (see <a href="https://www.postgresql.org/docs/14/datatype-datetime.html">Docs</a> for details)</li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: MySQL</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sqlmysql code-with-copy"><code class="sourceCode sqlmysql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> products;</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="st">`products`</span><span class="ch">.</span><span class="st">`prices`</span> (</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">`pid`</span> <span class="dt">int</span>(<span class="dv">11</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">AUTO_INCREMENT</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`category`</span> <span class="dt">varchar</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`price`</span> <span class="dt">float</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="st">`pid`</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> products<span class="ch">.</span>prices</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    (pid, category, price)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="st">'A'</span>, <span class="dv">2</span>),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="st">'A'</span>, <span class="dv">1</span>),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>, <span class="st">'A'</span>, <span class="dv">5</span>),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span>, <span class="st">'A'</span>, <span class="dv">4</span>),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">5</span>, <span class="st">'A'</span>, <span class="dv">3</span>),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">6</span>, <span class="st">'B'</span>, <span class="dv">6</span>),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">7</span>, <span class="st">'B'</span>, <span class="dv">4</span>),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">8</span>, <span class="st">'B'</span>, <span class="dv">3</span>),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">9</span>, <span class="st">'B'</span>, <span class="dv">5</span>),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">10</span>, <span class="st">'B'</span>, <span class="dv">2</span>),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">11</span>, <span class="st">'B'</span>, <span class="dv">1</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="sec-sql-basics-add" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-basics-add">Add Data</h3>
<ul>
<li><p><span class="ribbon-highlight">Example</span>: Add data via .csv</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> assignments(<span class="kw">category</span>, name, due_date, weight)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="st">'C:/Users/mgsosna/Desktop/db_data/assignments.csv'</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>DELIMITER <span class="st">','</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>CSV <span class="kw">HEADER</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><span class="var-text">assignments</span> is the table; [category][assignments], [name][assignments], [due_date][assignments], [weight][assignments] are fields that you want to import from the csv file</li>
<li>** The order of the columns must be the same as the ones in the CSV file **</li>
<li><code>HEADER</code> keyword to indicate that the CSV file contains a header</li>
<li>Might need to have superuser access in order to execute the <code>COPY</code> statement successfully</li>
</ul></li>
</ul>
</section>
<section id="update-table" class="level3">
<h3 class="anchored" data-anchor-id="update-table">Update Table</h3>
<ul>
<li><p>Resources</p>
<ul>
<li><a href="https://hakibenita.com/postgresql-get-or-create">How to Get or Create in PostgreSQL</a>
<ul>
<li>Deep dive on using <code>INSERT</code> and <code>MERGE</code></li>
</ul></li>
</ul></li>
<li><p>Check if a table is updatable</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> table_name, is_updatable</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> information_schema.views</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Useful if some of the tables you are working with are missing values that you need to add</li>
<li>If not updatable, then you’ll need to contact the database administrator to request permission to update that specific table</li>
</ul></li>
<li><p>Update target table by transaction id (BQ)(<a href="https://towardsdatascience.com/advanced-sql-techniques-for-beginners-211851a28488">link</a>)</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> target_table (transaction_id)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> transaction_id </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">from</span> source_table </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> transaction_id <span class="op">&gt;</span> (<span class="kw">select</span> <span class="fu">max</span>(transaction_id) <span class="kw">from</span> target_table)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Might not be possible with denormalized star-schema datasets in modern data warehouses.</li>
</ul></li>
<li><p>Update Target Table by transaction date (BQ) (<a href="https://towardsdatascience.com/advanced-sql-techniques-for-beginners-211851a28488">link</a>)</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> last_online t</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> (</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>      user_id,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      last_online</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">from</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">select</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>            user_id,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(<span class="dt">timestamp</span>) <span class="kw">as</span> last_online</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">from</span> </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>            connection_data</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">where</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">date</span>(_partitiontime) <span class="op">&gt;=</span> date_sub(<span class="fu">current_date</span>(), </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>                                             <span class="dt">interval</span> <span class="dv">1</span> <span class="dt">day</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">group</span> <span class="kw">by</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>            user_id</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    ) y</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>) s</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="kw">on</span> t.user_id <span class="op">=</span> s.user_id</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="cf">when</span> matched <span class="cf">then</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">update</span> <span class="kw">set</span> last_online <span class="op">=</span> s.last_online, </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>             user_id <span class="op">=</span> s.user_id</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="cf">when</span> <span class="kw">not</span> matched <span class="cf">then</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">insert</span> (last_online, user_id) </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">values</span> (last_online, user_id)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> last_online</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>MERGE</code> performs <code>UPDATE</code>, <code>DELETE</code>, and <code>INSERT</code>
<ul>
<li>UPDATE or DELETE clause can be used when two or more data match.</li>
<li>INSERT clause can be used when two or more data are different and do not match.</li>
<li>The UPDATE or DELETE clause can also be used when the given data does not match the source.</li>
</ul></li>
<li><span class="arg-text">_partitiontime</span> is a field BQ creates to record the row’s ingestion time (See <a href="../qmd/google-bigquery.html#sec-goog-bigq-opt" style="color: green">Google, Big Query &gt;&gt; Optimization</a> &gt;&gt; Partitions</li>
</ul></li>
<li><p>Update Target Table with Source Data (<a href="https://towardsdatascience.com/data-warehouse-design-patterns-d7c1c140c18b">link</a>)</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">MERGE</span> <span class="kw">INTO</span> target_table tgt</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">USING</span> source_table src </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">ON</span> tgt.customer_id <span class="op">=</span> src.customer_id</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">WHEN</span> <span class="kw">MATCHED</span> <span class="cf">THEN</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a> <span class="kw">UPDATE</span> <span class="kw">SET</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>   tgt.is_active <span class="op">=</span> src.is_active,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>   tgt.updated_date <span class="op">=</span> <span class="vs">'2024-04-01</span><span class="st">'</span><span class="ch">::</span><span class="dt">DATE</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="cf">WHEN</span> <span class="kw">NOT</span> <span class="kw">MATCHED</span> <span class="cf">THEN</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a> <span class="kw">INSERT</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>   (customer_id, is_active, updated_date)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a> <span class="kw">VALUES</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a> (src.customer_id, src.is_active, <span class="vs">'2024-04-01</span><span class="st">'</span><span class="ch">::</span><span class="dt">DATE</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>; </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The statement uses the <code>MERGE</code> keyword to conditionally update or insert rows into a target table based on a source table.</li>
<li>It matches rows between the tables using the <code>ON</code> clause and the <code>customer_id</code> column.</li>
<li>The <code>WHEN MATCHED THEN</code> clause specifies the update actions for matching rows.</li>
<li>The <code>WHEN NOT MATCHED THEN</code> clause specifies the insert actions for rows that don’t have a match in the target table.</li>
<li>The <code>::DATE</code> cast ensures that the <code>updated_date</code> value is treated as a date.</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-basics-del" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-basics-del">Delete Rows</h3>
<ul>
<li><code>DELETE CASCADE</code>
<ul>
<li><p>Deletes related rows in child tables when a parent row is deleted from the parent table</p></li>
<li><p>Apply cascade to foreign key in the child table</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> parent_table(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">SERIAL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">..</span>.</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> child_table(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">id</span> <span class="dt">SERIAL</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    parent_id <span class="dt">INT</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    FOREIGN_KEY(parent_id) </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>       <span class="kw">REFERENCES</span> parent_table(<span class="kw">id</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>       <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>In the child table, the <span class="var-text">parent_id</span> is a foreign key that references the <span class="var-text">id</span> column of the <span class="var-text">parent_table</span>.</p></li>
<li><p>The <code>ON DELETE CASCADE</code> is the action on the foreign key that will automatically delete the rows from the <span class="var-text">child_table</span> whenever corresponding rows from the <span class="var-text">parent_table</span> are deleted.</p></li>
<li><p><span class="ribbon-highlight">Example</span></p>
<pre class="sqlpostgressql"><code>DELETE FROM parent_table 
WHERE id = 1;</code></pre>
<ul>
<li>id = 1 in parent_table corresponds to parent_id = 1 in child_table. Therefore, all rows matching those conditions in <em>both</em> tables will be deleted.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-basics-subq" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-basics-subq">Subqueries</h3>
<ul>
<li><p>**Using CTEs instead of subqueries make code more readable**</p>
<ul>
<li>Subqueries make it difficult to understand their context in the larger query</li>
<li>The only way to debug a subquery is by turning it into a CTE or pulling it out of the query entirely.</li>
<li>CTEs and subqueries have a similar runtime, but subqueries make your code more complex for no reason.</li>
</ul></li>
<li><p>Notes from <a href="https://towardsdatascience.com/how-to-use-subqueries-in-sql-da660694b8e3">How to Use SubQueries in SQL</a></p>
<ul>
<li>Also shows the alt method of creating a temporary table to compute the queries</li>
</ul></li>
<li><p>Use cases</p>
<ul>
<li>Filtering rows from a table with the context of another.</li>
<li>Performing double-layer aggregations such as average of averages or an average of sums.</li>
<li>Accessing aggregations with a subquery.</li>
</ul></li>
<li><p>Tables used in examples</p>
<ul>
<li>Store A (store_a)<br>
<a href="./_resources/SQL.resources/image.10.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="./_resources/SQL.resources/image.10.png" class="img-fluid" width="300"></a>
<ul>
<li>Store B is similar</li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Filtering rows</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> sandbox.store_b</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> product_id <span class="kw">IN</span> (</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">select</span> product_id</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">from</span> sandbox.store_b</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">group</span> <span class="kw">by</span> product_id&nbsp;</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">having</span> <span class="fu">count</span>(product_id) <span class="op">&gt;=</span> <span class="dv">3</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>filters the rows with products that have been bought at least three times in store_b</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Multi-Layer Aggregation</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="fu">avg</span>(average_price.total_value) <span class="kw">as</span> average_transaction <span class="kw">from</span> (</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">select</span> transaction_id, <span class="fu">sum</span>(price_paid) <span class="kw">as</span> total_value</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">from</span> sandbox.store_a</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">group</span> <span class="kw">by</span> transaction_id</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>&nbsp; ) <span class="kw">as</span> average_price</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>computes the average of all transactions</li>
<li>can’t apply an average directly, as our table is oriented to product_ids and not to transaction_ids</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Filtering the table based on an Aggregation</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> @avg_transaction<span class="op">:=</span> <span class="fu">avg</span>(agg_table.total_value)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> (</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> transaction_id, <span class="fu">sum</span>(price_paid) <span class="kw">as</span> total_value</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">from</span> sandbox.store_a</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">group</span> <span class="kw">by</span> transaction_id</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>) <span class="kw">as</span> agg_table;</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span>&nbsp;</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> sandbox.store_a</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> transaction_id <span class="kw">in</span> (</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> transaction_id</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">from</span> sandbox.store_a</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">group</span> <span class="kw">by</span> transaction_id</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">having</span> <span class="fu">sum</span>(price_paid) <span class="op">&gt;</span> @avg_transaction</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>filters transactions that have a value higher than the average (where the output must retain the original product-oriented row)</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-basics-joins" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-basics-joins">Joins</h3>
<p><a href="./_resources/SQL.resources/FPggFYUUcAszeHX.jpeg" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="./_resources/SQL.resources/FPggFYUUcAszeHX.jpeg" class="img-fluid" width="354"></a><br>
<a href="./_resources/SQL.resources/FPggFYRVkAMc93Z.jpeg" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="./_resources/SQL.resources/FPggFYRVkAMc93Z.jpeg" class="img-fluid" width="354"></a></p>
<ul>
<li><p>Cross Join -&nbsp; acts like an expand_grid; where each value in the join key column gets all combinations of rows in both tables (also see above pic)<br>
<a href="./_resources/SQL.resources/image.9.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="./_resources/SQL.resources/image.9.png" class="img-fluid" width="296"></a></p>
<ul>
<li><p>Efficient join</p></li>
<li><p>When you add the <code>where</code> clause, the cross join acts similarly to an <code>inner join</code>, except you aren’t joining it on any specified column</p></li>
<li><p><span class="ribbon-highlight">Example</span>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>&nbsp; schedule.event,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>&nbsp; calendar.number_of_days</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> schedule</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">CROSS</span> <span class="kw">JOIN</span> calendar</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> schedule.total_number <span class="op">&lt;</span> calendar.number_of_days</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Only join the row in the “schedule” table with the rows in the “calendar” table that meet the specified condition</li>
</ul></li>
</ul></li>
<li><p>Natural Join - don’t need to specify join columns; need to have two columns in each table with the same name</p>
<ul>
<li>Use cases
<ul>
<li>There are a lot of common columns with the same name across multiple tables
<ul>
<li>They will all be used as joining keys.</li>
</ul></li>
<li>You don’t want to type out all of the common columns in select just to avoid outputting the same columns multiple times.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> table_a</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">natural</span> <span class="kw">join</span> table_b</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- natural + outer</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> table_a</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="kw">natural</span> <span class="kw">outer</span> <span class="kw">join</span> table_b</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
</section>
<section id="sec-sql-r" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-r">R</h2>
<section id="sec-sql-r-misc" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-r-misc">Misc</h3>
<ul>
<li><a href="https://fosstodon.org/@sckottie/113319547849135263">Thread</a> regarding querying when permissions/privileges only allow partial access to a table (e.g.&nbsp;specific columns)</li>
</ul>
</section>
<section id="sec-sql-r-dbplyr" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-r-dbplyr"><span style="color: #990000">{dbplyr}</span></h3>
<ul>
<li><p><a href="https://dbplyr.tidyverse.org/">Docs</a></p></li>
<li><p>Queries will not be run and data will not be retrieved unless you ask for it: they all return a new <span class="arg-text">tbl_dbi</span> object.</p></li>
<li><p>Commands</p>
<ul>
<li>Use <code>compute()</code> to run the query and save the results in a temporary in the database</li>
<li>Use <code>collect()</code> to retrieve the results to R.</li>
<li>Use <code>show_query</code> to see the query.</li>
<li>Use <code>explain</code> to describe the query plan</li>
</ul></li>
<li><p>Syntax for accessing tables</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>con <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(<span class="fu">I</span>(<span class="st">"catalog_name.schema_name.table_name"</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>con <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(<span class="fu">I</span>(<span class="st">"schema_name.table_name"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Queries</p>
<ul>
<li><p>Query without bringing output into memory</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pixar_films <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"pixar_films"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>pixar_films <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.by =</span> film_rating, <span class="at">n =</span> <span class="fu">n</span>())</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Source:   SQL [4 x 2]</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Database: DuckDB v1.0.0</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   film_rating     n</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 Not Rated       1</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 PG             10</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 G              13</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 N/A             3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Query and bring output into memory</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_pixar_films_by_rating <span class="ot">&lt;-</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  pixar_films <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(film_rating) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p>Joins</p>
<ul>
<li><p>Two tables with the result outside of memory</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>academy <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"academy"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>academy_won <span class="ot">&lt;-</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  academy <span class="sc">|&gt;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(status <span class="sc">==</span> <span class="st">"Won"</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(film, <span class="at">name =</span> <span class="st">"n_won"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>academy <span class="sc">|&gt;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(pixar_films, <span class="fu">join_by</span>(film))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_won =</span> <span class="fu">coalesce</span>(n_won, <span class="dv">0</span>L)) <span class="sc">|&gt;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(release_date)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Source:     SQL [?? x 6]</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Database:   DuckDB v1.0.0</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Ordered by: release_date</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   film         n_won number release_…¹ run_t…²</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;  &lt;date&gt;       &lt;dbl&gt;</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 Toy Story        0 1      1995-11-22      81</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 A Bug's Life     0 2      1998-11-25      95</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 Toy Story 2      0 3      1999-11-24      92</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 Monsters, I…     1 4      2001-11-02      92</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 Finding Nemo     1 5      2003-05-30     100</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6 The Incredi…     2 6      2004-11-05     115</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ more rows</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ abbreviated names: ¹release_date, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Join a table and a tibble</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>academy <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    pixarfilms<span class="sc">::</span>pixar_films, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">join_by</span>(film), <span class="at">copy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Source:   SQL [?? x 7]</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Database: DuckDB v1.0.0</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   film      award_t…¹ status number release_…²</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt;  &lt;date&gt;    </span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 Toy Story Animated… Award… 1      1995-11-22</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 Toy Story Original… Nomin… 1      1995-11-22</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 Toy Story Adapted … Ineli… 1      1995-11-22</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 Toy Story Original… Nomin… 1      1995-11-22</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 Toy Story Original… Nomin… 1      1995-11-22</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6 Toy Story Other     Won S… 1      1995-11-22</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ more rows</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ abbreviated names: ¹award_type, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>A temporary table is created on the LHS database.</p></li>
<li><p>If the RHS comes from a different database, results are temporarily loaded into the local session</p></li>
<li><p>If the LHS is a in-memory tibble and the RHS is lazy table, then the result is a tibble.</p></li>
</ul></li>
</ul></li>
<li><p>Get query from dplyr code</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tbl_to_sql <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>&nbsp; dplyr<span class="sc">::</span><span class="fu">show_query</span>(tbl) <span class="sc">|&gt;</span>&nbsp;</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="fu">capture.output</span>() <span class="sc">|&gt;</span>&nbsp;</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; purrr<span class="sc">::</span><span class="fu">discard_at</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span>&nbsp;</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">" "</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>show_query</code> outputs a separate line for each expression. This code transforms query output into a one long string.</li>
<li>Also see <a href="https://emilyriederer.netlify.app/post/sql-generation/">Generating SQL with <span style="color: #990000">{dbplyr}</span> and sqlfluff</a></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-r-dbi" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-r-dbi"><span style="color: #990000">{DBI}</span></h3>
<ul>
<li><p>Other drivers: <code>RPostgres::Postgres()</code>, <code>RPostgres::Redshift()</code></p></li>
<li><p>Connect to a generic database</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>get_database_conn <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  conn <span class="ot">&lt;-</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    DBI<span class="sc">::</span><span class="fu">dbConnect</span>(</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">drv =</span> odbc<span class="sc">::</span><span class="fu">odbc</span>(),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">driver =</span> <span class="st">"driver name here"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">server =</span> <span class="st">"server string here"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">UID =</span> <span class="fu">Sys.getenv</span>(<span class="st">"DB_USER"</span>),</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">PWD =</span> <span class="fu">Sys.getenv</span>(<span class="st">"DB_PASS"</span>),</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">port =</span> <span class="st">"port number here"</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(conn)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Connect to or Create a SQLite database</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(<span class="at">drv =</span> RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(),</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"db_name.db"</span>),</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="at">timeout =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Connect to Microsoft SQL Server</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(),&nbsp;</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="at">Driver =</span> <span class="st">"SQL Server"</span>,&nbsp;</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="at">Server =</span> <span class="st">"SERVER"</span>,&nbsp;</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="at">Database =</span> <span class="st">"DB_NAME"</span>,&nbsp;</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="at">Trusted_Connection =</span> <span class="st">"True"</span>,&nbsp;</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="at">Port =</span> <span class="dv">1433</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Connect to MariaDB</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname =</span> <span class="st">"CORA"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">username =</span> <span class="st">"guest"</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> <span class="st">"ctu-relational"</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="st">"relational.fel.cvut.cz"</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Close connection: <code>dbDisconnect(con)</code></p></li>
<li><p>List Tables and Fields</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListTables</span>(con)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "academy"         "box_office"     </span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3] "genres"          "pixar_films"    </span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5] "pixar_people"    "public_response"</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dbListFields</span>(con, <span class="st">"box_office"</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "film"                </span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2] "budget"              </span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3] "box_office_us_canada"</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [4] "box_office_other"    </span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5] "box_office_worldwide"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Cancel a running query (postgres)</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store PID</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>pid <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetInfo</span>(conn)<span class="sc">$</span>pid</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cancel query and get control of IDE back</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># SQL command</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>SELECT <span class="fu">pg_cancel_backend</span>(<span class="sc">&lt;</span>PID<span class="sc">&gt;</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Useful if query is running too long and you want control of your IDE back</li>
</ul></li>
<li><p>Create single tables from a list of tibbles to a database</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map2</span>(table_names, list_of_tbls, <span class="sc">~</span> <span class="fu">dbWriteTable</span>(con, .x, .y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Load all tables from a database into a list</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>tables <span class="ot">&lt;-</span> <span class="fu">dbListTables</span>(con)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> <span class="fu">map</span>(tables, dbReadTable, <span class="at">conn =</span> con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Can use <code>map_dfr</code> if all the tables have the same columns</li>
</ul></li>
<li><p>Queries</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT * FROM pixar_films</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE release_date &gt;= '2020-01-01'</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># or with &gt; R 4.0</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> r<span class="st">"(</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT * FROM "</span>pixar_films<span class="st">"</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE "</span>release_date<span class="st">" &gt;= '2020-01-01'</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="st">)"</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(con, sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>dbExecute</code> is for queries/procedures that <em>do not</em> return a result. It does return a numeric that specifies the number of rows affected by the statement.</li>
</ul></li>
<li><p>Dynamic queries</p>
<ul>
<li><p>Resources</p>
<ul>
<li>Converting a SQL script into R, splitting the queries, and parameterizing them (<a href="https://aidememoire.netlify.app/rstats/clean_and_execute_sql_script">article</a>)</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: MS SQL Server with <span style="color: #990000">{glue}</span></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"columns"</span>, <span class="st">"you"</span>, <span class="st">"want"</span>, <span class="st">"to"</span>, <span class="st">"select"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>date_var <span class="ot">&lt;-</span> <span class="st">'date_col'</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">'2022-01-01'</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>today <span class="ot">&lt;-</span> <span class="fu">Sys.Date</span>()</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>tablename <span class="ot">&lt;-</span> <span class="st">"yourtablename"</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>schema_name <span class="ot">&lt;-</span> <span class="st">"yourschema"</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="fu">glue_sql</span>(<span class="at">.con =</span> con, <span class="st">"SELECT TOP(10) {`vars`*} FROM {`schema_name`}.{`tablename`} "</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, query)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>vars</code> format collapses the vars vector, separated by commas, so that it resembles a SELECT statement</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Using params</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>quoted_column <span class="ot">&lt;-</span> <span class="st">"release_date"</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"SELECT * FROM academy WHERE "</span>, quoted_column, <span class="st">" = ?"</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(con, sql,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">params =</span> <span class="fu">list</span>(<span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>))</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>?</code> acts a placeholder that gets filled by the params argument</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-r-prql" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-r-prql">PRQL</h3>
<ul>
<li><p><a href="https://prql-lang.org/book/">Docs</a></p></li>
<li><p><span style="color: #990000">{</span><a href="https://eitsupi.github.io/prqlr/" style="color: #990000">prqlr</a><span style="color: #990000">}</span></p></li>
<li><p>A dplyr + SQL hybrid language</p></li>
<li><p>Using with DuckDB</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(prqlr); <span class="fu">library</span>(duckdb)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>(), <span class="at">dbdir =</span> <span class="st">":memory"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"mtcars"</span>, mtcars)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="st">"from mtcars | filter cyl &gt; 6 | select {cyl, mpg}"</span> <span class="sc">|&gt;</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prql_compile</span>() <span class="sc">|&gt;</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbGetQuery</span>(<span class="at">conn =</span> con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="sec-sql-r-dm" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-r-dm"><span style="color: #990000">{dm}</span></h3>
<ul>
<li><p>See <a href="../qmd/db-normalization.html#sec-db-norm-misc" style="color: green">Databases, Normalization &gt;&gt; Misc</a> &gt;&gt; Packages &gt;&gt; <span style="color: #990000">{dm}</span></p></li>
<li><p>Connect to all tables and get the number of rows</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  RMariaDB<span class="sc">::</span><span class="fu">MariaDB</span>(),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname =</span> <span class="st">"CORA"</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">username =</span> <span class="st">"guest"</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> keyring<span class="sc">::</span><span class="fu">key_get</span>(...),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="st">"relational.fel.cvut.cz"</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 tables: paper, content, cities</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(con)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>dm <span class="sc">|&gt;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_nrow</span>()</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  paper content   cites </span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   2708   49216    5429</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Subset one table and do stuff to it</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>pixar_dm <span class="sc">|&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_zoom_to</span>(academy) <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    pixar_films, <span class="at">select =</span> release_date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Join all related tables into one wide table</p>
<pre><code>pixar_dm |&gt;
  dm_flatten_to_tbl(academy)</code></pre></li>
</ul>
</section>
</section>
<section id="sec-sql-bestp" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-bestp">Best Practices</h2>
<ul>
<li>Misc
<ul>
<li>Resources
<ul>
<li><a href="https://www.sqlstyle.guide/">SQL Style Guide</a></li>
</ul></li>
<li>Use aliases only when table names are long enough so that using them improves readability (but choose meaningful aliases)</li>
<li>Do not use&nbsp;SELECT *. Explicitly list columns instead</li>
<li>Use comments to document business logic</li>
<li>A comment at the top should provide a high-level description</li>
<li>Use an auto-formatter</li>
<li>General Optimizations
<ul>
<li>Removing duplicates or filtering out null values at the beginning of your model will speed up queries</li>
<li>Replace complex code with window functions
<ul>
<li><p><span class="ribbon-highlight">Example</span>: Replace <code>GROUP_BY</code> + <code>TOP</code> with a partition + <code>FIRST_VALUE()</code></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FIRST_VALUE</span>(test_score) <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> student_name <span class="kw">ORDER</span> <span class="kw">BY</span> test_score <span class="kw">DESC</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: <code>AVG(test_score) OVER(PARTITION BY student_name)</code></p></li>
</ul></li>
</ul></li>
</ul></li>
<li>CTEs
<ul>
<li>Break down logic in CTEs using&nbsp;WITH … AS</li>
<li>The&nbsp;SELECT&nbsp;statement inside each CTE must do a single thing (join, filter or aggregate)</li>
<li>The CTE name should provide a high-level explanation</li>
<li>The last statement should be a&nbsp;SELECT&nbsp;statement querying the last CTE</li>
</ul></li>
<li>Joins
<ul>
<li>Use&nbsp;WHERE&nbsp;for filtering, not for joining</li>
<li>Favor&nbsp;LEFT JOIN&nbsp;over&nbsp;INNER JOIN; in most cases, it’s essential to know the distribution of&nbsp;NULLs</li>
<li>Avoid using”Self-Joins.” Use window functions instead (see <a href="../qmd/google-bigquery.html#sec-goog-bigq-opt" style="color: green">Google, BigQuery &gt;&gt; Optimization</a> for details on self-joins)</li>
<li>When doing equijoins (i.e., joins where all conditions have the&nbsp;something=another&nbsp;form), use the&nbsp;USING&nbsp;keyword</li>
<li>Break-up joins using OR into UNION because SQL uses nested operations for JOIN + OR queries which slow things.
<ul>
<li>Bad<br>
<a href="./_resources/SQL.resources/1-9K5I9iIKl5gUoYe9mw2CXw.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="./_resources/SQL.resources/1-9K5I9iIKl5gUoYe9mw2CXw.png" class="img-fluid" width="335"></a></li>
<li>Good<br>
<a href="./_resources/SQL.resources/1-rXsv2pEUKL3qBkM7DK8bVQ.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="./_resources/SQL.resources/1-rXsv2pEUKL3qBkM7DK8bVQ.png" class="img-fluid" width="328"></a></li>
</ul></li>
</ul></li>
<li>Style Guide<br>
<a href="./_resources/SQL.resources/1-HOcSBns8ec2jIO5A0gGHEw.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="./_resources/SQL.resources/1-HOcSBns8ec2jIO5A0gGHEw.png" class="img-fluid" width="752"></a></li>
</ul>
</section>
<section id="sec-sql-index" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-index">Indexes</h2>
<ul>
<li><p>Misc</p>
<ul>
<li>An index may consist of up to 16 columns</li>
<li>The first column of the index must always be present in the query’s filter, order , join or group operations to be used</li>
</ul></li>
<li><p>Create Index on an existing table (postgres)</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; score_index <span class="kw">ON</span> grades(score, student);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“score_index” is the name of the index</li>
<li>“grades” is the name of the table</li>
<li>“score” and “student” are fields to be used as the indexes</li>
</ul></li>
<li><p>Create Index that only uses a specific character length</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* mysql */</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> test (blob_col <span class="dt">BLOB</span>, <span class="kw">INDEX</span>(blob_col(<span class="dv">10</span>)));</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>index only uses the first 10 characters of the column value of a BLOB column type</li>
</ul></li>
<li><p>Create index with multiple columns</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* mysql */</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> test (</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; id&nbsp; &nbsp; &nbsp; &nbsp; <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; last_name&nbsp; <span class="dt">CHAR</span>(<span class="dv">30</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; first_name <span class="dt">CHAR</span>(<span class="dv">30</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">INDEX</span> name (last_name,first_name)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Usage of multiple column index (** order of columns is important **)</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> last_name<span class="op">=</span><span class="st">'Jones'</span>;</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">WHERE</span> last_name<span class="op">=</span><span class="st">'Jones'</span> <span class="kw">AND</span> first_name<span class="op">=</span><span class="st">'John'</span>;</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">WHERE</span> last_name<span class="op">=</span><span class="st">'Jones'</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">AND</span> (first_name<span class="op">=</span><span class="st">'John'</span> <span class="kw">OR</span> first_name<span class="op">=</span><span class="st">'Jon'</span>);</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">WHERE</span> last_name<span class="op">=</span><span class="st">'Jones'</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">AND</span> first_name <span class="op">&gt;=</span><span class="st">'M'</span> <span class="kw">AND</span> first_name <span class="op">&lt;</span> <span class="st">'N'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Index is used when both columns are used as part of filtering criteria or when only the left-most column is used</p></li>
<li><p>if you have a three-column index on (col1, col2, col3), you have indexed search capabilities on (col1), (col1, col2), and (col1, col2, col3).</p></li>
</ul></li>
<li><p><em>Invalid</em> usage of multiple column index</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test <span class="kw">WHERE</span> first_name<span class="op">=</span><span class="st">'John'</span>;</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> test</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">WHERE</span> last_name<span class="op">=</span><span class="st">'Jones'</span> <span class="kw">OR</span> first_name<span class="op">=</span><span class="st">'John'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The “name” index won’t be used in these queries since
<ul>
<li>first_name is NOT the left-most column specified in the index</li>
<li>OR is used instead of AND</li>
</ul></li>
</ul></li>
<li><p>Create index with DESC, ASC</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* mysql */</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> t (</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>&nbsp; c1 <span class="dt">INT</span>, c2 <span class="dt">INT</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">INDEX</span> idx1 (c1 <span class="kw">ASC</span>, c2 <span class="kw">ASC</span>),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">INDEX</span> idx2 (c1 <span class="kw">ASC</span>, c2 <span class="kw">DESC</span>),</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">INDEX</span> idx3 (c1 <span class="kw">DESC</span>, c2 <span class="kw">ASC</span>),</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">INDEX</span> idx4 (c1 <span class="kw">DESC</span>, c2 <span class="kw">DESC</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Used by <code>ORDER BY</code>
<ul>
<li>See <a href="https://dev.mysql.com/doc/refman/8.0/en/descending-indexes.html">Docs</a> to see what operations and index types support Descending Indexes</li>
</ul></li>
<li>Note: idx_a on column_p, column_q desc is not the same as an * Index idx_a on column_q desc, column p or, * Index idx_b on column_p desc, column q</li>
</ul></li>
<li><p>Usage of Descending Indexes</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> c1 <span class="kw">ASC</span>, c2 ASC&nbsp; &nbsp; <span class="co">-- optimizer can use idx1</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> c1 <span class="kw">DESC</span>, c2 DESC&nbsp; <span class="co">-- optimizer can use idx4</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> c1 <span class="kw">ASC</span>, c2 DESC&nbsp; <span class="co">-- optimizer can use idx2</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> c1 <span class="kw">DESC</span>, c2 ASC&nbsp; <span class="co">-- optimizer can use idx3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>See previous example for definition of idx* names</li>
<li>See <a href="https://dev.mysql.com/doc/refman/8.0/en/descending-indexes.html">Docs</a> to see what operations and index types support Descending Indexes</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-part" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-part">Partitioning</h2>
<ul>
<li>Misc
<ul>
<li>Also see
<ul>
<li>MySQL <a href="https://dev.mysql.com/doc/refman/8.0/en/partitioning-types.html">Docs</a></li>
<li><a href="../qmd/google-bigquery.html#sec-goog-bigq-opt" style="color: green">Google, BigQuery &gt;&gt; Optimization &gt;&gt; Partitioning and Clustering</a></li>
<li><a href="../qmd/db-engineering.html#sec-db-eng-costopt" style="color: green">DB, Engineering &gt;&gt; Cost Optimization &gt;&gt; Partitioning</a></li>
</ul></li>
<li>all of your queries to the partitioned table must contain the <code>partition_key</code> in the <code>WHERE</code> clause</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-views" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-views">Views</h2>
<ul>
<li><p>A smaller data object that contains the subset of data resulting from a specific query</p></li>
<li><p>If a table structure changes, the database can flag affected views for review.</p></li>
<li><p>Types</p>
<ul>
<li>Materialized Views
<ul>
<li>Stores data and require refreshing</li>
<li>Whereas a query happens after data is loaded, a materialized view is a precomputation (Basically, it’s a cached result)</li>
<li>Can offer better performance for complex queries</li>
</ul></li>
<li>Standard Views
<ul>
<li>Essentially saved queries that run each time you access the view. This means that when you query a standard view, you’re always seeing the current data in the underlying tables.</li>
<li>Not separate storage</li>
</ul></li>
</ul></li>
<li><p>For Materialized Views and in postgres, you just need to replace <code>VIEW</code> with <code>MATERIALIZED VIEW</code> in the commands</p></li>
<li><p>Create a View</p>
<ul>
<li><p><span class="ribbon-highlight">Example</span>: Create view as select (CVAS)</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> high_earner <span class="kw">AS</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> p.<span class="kw">id</span> <span class="kw">AS</span> person_id, j.salary</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> People p</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> Job j</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> p.job <span class="op">=</span> j.title</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> j.salary <span class="op">&gt;=</span> <span class="dv">200000</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p>Query a view (same as a table): <code>SELECT * FROM high_earner</code></p></li>
<li><p>Update view</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">VIEW</span> high_earner <span class="kw">AS</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> p.<span class="kw">id</span> <span class="kw">AS</span> person_id, j.salary</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> People p</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> Job j</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> p.job <span class="op">=</span> j.title</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> j.salary <span class="op">&gt;=</span> <span class="dv">150000</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Expects the query output to retain the same number of columns, column names, and column data types. Thus, any modification that results in a change in the data structure will raise an error.</li>
</ul></li>
<li><p>Change view name or a column name</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">VIEW</span> foo <span class="kw">RENAME</span> <span class="kw">TO</span> bar;</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">VIEW</span> foo <span class="kw">RENAME</span> <span class="kw">COLUMN</span> moose <span class="kw">TO</span> squirrel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Refresh Materialized View</p>
<ul>
<li><p>Non-Concurrently</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">REFRESH</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> view_name;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Might block users while view is being refreshed</li>
<li>Best for cases in which a lot of rows are affected.</li>
</ul></li>
<li><p>Concurrently</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">UNIQUE</span> <span class="kw">INDEX</span> idx_view_name <span class="kw">ON</span> view_name (column1, column2);</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">REFRESH</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> <span class="kw">CONCURRENTLY</span> view_name;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Refreshes while not blocking other people using this view (i.e.&nbsp;concurrent access to view)</li>
<li>Best for cases in which only a small number of rows are affected</li>
<li>Requires index</li>
</ul></li>
</ul></li>
<li><p>List views<br>
<a href="./_resources/SQL.resources/image.4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="./_resources/SQL.resources/image.4.png" class="img-fluid" width="500"></a></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> information_schema.views</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> table_schema <span class="kw">NOT</span> <span class="kw">IN</span> (<span class="st">'pg_catalog'</span>, <span class="st">'information_schema'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“table_name” has the names of the views</li>
<li>“view_definition” shows the query stored in the view</li>
<li>WHERE command is included to omit built-in views from PostgreSQL.</li>
</ul></li>
<li><p>Delete view: <code>DROP VIEW high_earner;</code></p></li>
</ul>
</section>
<section id="sec-sql-vars" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-vars">Variables</h2>
<ul>
<li>Misc
<ul>
<li>Also see <a href="../qmd/sql.html#sec-sql-bizq" style="color: green">Business Queries</a> &gt;&gt; Medians</li>
</ul></li>
<li>User-defined
<ul>
<li><p>DECLARE and SET</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Declare your variables</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> @start <span class="dt">date</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> @stop <span class="dt">date</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- SET the relevant values for each variable</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @start <span class="op">=</span> <span class="st">'2021-06-01'</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @stop <span class="op">=</span> GETDATE()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>DECLARE sets the variable type (e.g.&nbsp;date)</li>
<li>SET assigns a value</li>
</ul></li>
<li><p>Or just use DECLARE</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> @Iteration <span class="dt">Integer</span> <span class="op">=</span> <span class="dv">0</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Examples</p>
<ul>
<li><p><span class="ribbon-highlight">Example</span>: Exclude 3 months of data from the query</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t1.[DATETIME], <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> vol</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Medium.dbo.Earthquakes t1</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> t1.[DATETIME] <span class="kw">BETWEEN</span> @start <span class="kw">AND</span> DATEADD(<span class="dt">MONTH</span>, <span class="op">-</span><span class="dv">3</span>, @stop)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> t1.[DATETIME]</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> t1.[DATETIME] <span class="kw">DESC</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>See above for the definitions of <span class="citation" data-cites="start">@start</span> and <span class="citation" data-cites="stop">@stop</span></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Apply a counter</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Declare the variable (a SQL Command, the var name, the datatype)</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> @counter <span class="dt">INT</span>;</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Set the counter to 20</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @counter <span class="op">=</span> <span class="dv">20</span>;</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Print the initial value</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="kw">AS</span> _COUNT;</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- Select and increment the counter by one</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="op">=</span> @counter <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- Print variable</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="kw">AS</span> _COUNT;</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Select and increment the counter by one</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="op">+=</span> <span class="dv">1</span>;</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Print the variable</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="kw">AS</span> _COUNT;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul></li>
<li>System
<ul>
<li>ROWCOUNT - returns the number of rows affected by the last previous statement
<ul>
<li><p><span class="ribbon-highlight">Example</span></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; product_id,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; product_name</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; production.products</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">WHERE</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; list_price <span class="op">&gt;</span> <span class="dv">100000</span>;</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="cf">IF</span> @@ROWCOUNT <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; PRINT <span class="st">'No product with price greater than 100000 found'</span>;</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-funs" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-funs">Functions</h2>
<ul>
<li><p>“||” Concantenate strings. e.g ‘Post’ || ‘greSQL’ –&gt; PostgreSQL</p></li>
<li><p><code>BEGIN</code>…<code>END</code> - defines a compound statement or statement block. A compound statement consists of a set of SQL statements that execute together. A statement block is also known as a batch</p>
<ul>
<li>A compound statement can have a local declaration for a variable, a cursor, a temporary table, or an exception
<ul>
<li>Local declarations can be referenced by any statement in that compound statement, or in any compound statement nested within it.</li>
<li>Local declarations are invisible to other procedures that are called from within a compound statement</li>
</ul></li>
</ul></li>
<li><p><code>COMMIT</code> - a transaction control language that is used to permanently save the changes done in the transaction in tables/databases. The database cannot regain its previous state after its execution of commit.</p></li>
<li><p><code>DATEADD</code> - adds units of time to a variable or value</p>
<ul>
<li>e.g.&nbsp;<code>DATEADD(month, -3, '2021-06-01')</code>
<ul>
<li>subtracts 3 months from 2021-06-01</li>
</ul></li>
</ul></li>
<li><p><code>DATE_TRUNC</code> - pulls a component of a date object.</p>
<ul>
<li>e.g.&nbsp;<code>date_trunc('month', date_var) as month</code></li>
</ul></li>
<li><p><code>DENSE_RANK</code>- similar to the <code>RANK</code> , but it does not skip any numbers even if there is a tie between the rows.</p>
<ul>
<li>Values are ranked by the column specified in ORDER BY expression of the window function</li>
</ul></li>
<li><p><code>EXPLAIN</code> - a means of running your query as a what-if to see what the planner thinks about it. It will show the process the system goes through to get to the data and return it.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; s.<span class="kw">id</span> <span class="kw">AS</span> student_id,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; g.score</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; students <span class="kw">AS</span> s</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; grades <span class="kw">AS</span> g</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">ON</span> s.<span class="kw">id</span> <span class="op">=</span> g.student_id</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; g.score <span class="op">&gt;</span> <span class="dv">90</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; g.score <span class="kw">DESC</span>;</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="co">QUERY PLAN</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="co">----------</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co">Sort (cost=80.34..81.88 rows=617 width=8)</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="co">[...] Sort Key: g.score DESC</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="co">[...] -&gt; Hash Join (cost=16.98..51.74 rows=617 width=8)</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="co">[...] Hash Cond: (g.student_id = s.id)</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="co">[...] -&gt; Seq Scan on grades g (cost=0.00..33.13 rows=617 width=8)</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="co">[...] Filter: (score &gt; 90)</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a><span class="co">[...] -&gt; Hash (cost=13.10..13.10 rows=310 width=4)</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="co">[...] -&gt; Seq Scan on students s (cost=0.00..13.20 rows=320 width=4)</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Sequentially scanning (“Seq Scan”) the grades and students tables because the tables aren’t indexed
<ul>
<li>Any Seq Scan, parallel or not, is sub-optimal</li>
</ul></li>
<li><code>EXPLAIN (BUFFERS)</code> also shows how may data pages the database had to fetch using slow disk read operations (“read”), and how many of them were cached in memory (“shared hit”)</li>
<li>Also see <a href="../qmd/db-engineering.html#sec-db-eng-costopt" style="color: green">Databases, Engineering &gt;&gt; Cost Optimizations</a></li>
</ul></li>
<li><p><code>EXPLAIN ANALYZE</code> - tells the planner to not only hypothesize on what it would do, but actually run the query and show the results.</p>
<ul>
<li>Shows where indexes are being hit — or not hit as it may be. You can step through and re-optimize your basic and complex queries.</li>
<li>Also see <a href="../qmd/db-engineering.html#sec-db-eng-costopt" style="color: green">Databases, Engineering &gt;&gt; Cost Optimizations</a></li>
</ul></li>
<li><p><code>GETDATE()</code> - Gets the current date</p></li>
<li><p><code>GO</code> - Not a sql function. Used by some interpreters as a reset.</p>
<ul>
<li>i.e.&nbsp;any variables set before the GO statement will now not be recognized by the interpreter.</li>
<li>Helps to separate code into different sections</li>
</ul></li>
<li><p><code>ISDATE</code> - boolean - checks that a variable is a date type</p></li>
<li><p><code>QUALIFY</code> - clause filters the results of window functions.</p>
<ul>
<li>useful when answering questions like fetching the most XXX value of each category</li>
<li>QUALIFY does with window functions as what HAVING does with GROUP BY. As a result, in the order of execution, QUALIFY is evaluated after window functions.</li>
<li>See Business Queries &gt;&gt; Get the latest order from each customer</li>
</ul></li>
<li><p><code>UNION</code> - It joins the outputs of two separate SELECT statements or tables. UNION keeps all rows in the first table/select statement or the second table/select statement. It also retains only one occurrence of duplicated rows if there are any.</p>
<ul>
<li>i.e.&nbsp;It’s like if you <code>row_bind</code> two dataframes and then only keep the unique rows.</li>
</ul></li>
<li><p><code>UNNEST</code> - BigQuery - takes an ARRAY and returns a table with a row for each element in the ARRAY (<a href="https://medium.com/firebase-developers/how-to-use-select-from-unnest-to-analyze-multiple-parameters-in-bigquery-for-analytics-5838f7a004c2">docs</a>)</p>
<ul>
<li><a href="../qmd/google-analytics-analysis.html#sec-goog-anal-anal" style="color: green">Google Analytics, Analysis</a> &gt;&gt; Example 17</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-udfs" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-udfs">User Defined Functions (UDF)</h2>
<ul>
<li><p>Misc</p>
<ul>
<li>Available in SQL Server (<a href="https://learn.microsoft.com/en-us/sql/relational-databases/user-defined-functions/user-defined-functions?view=sql-server-ver16">Docs1</a>, <a href="https://learn.microsoft.com/en-us/sql/t-sql/statements/create-function-transact-sql?source=recommendations&amp;view=sql-server-ver16">Docs2</a>), Postgres (<a href="https://www.postgresql.org/docs/current/xfunc-sql.html">Docs</a>), BigQuery (<a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions">docs</a>), etc.</li>
<li>Keep a dictionary with the UDFs you’ve created and make sure to share it with any collaborators.</li>
<li>Can be persistent or temporary
<ul>
<li>Persistent UDFs can be used across multiple queries, while temporary UDFs only exist in the scope of a single query</li>
</ul></li>
</ul></li>
<li><p>Create</p>
<ul>
<li><p><span class="ribbon-highlight">Example</span>: temporary udf (BQ)</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> TEMP <span class="kw">FUNCTION</span> AddFourAndDivide(x INT64, y INT64)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>RETURNS FLOAT64</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> (</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>&nbsp; (x <span class="op">+</span> <span class="dv">4</span>) <span class="op">/</span> y</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>&nbsp; val, AddFourAndDivide(val, <span class="dv">2</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>&nbsp; UNNEST([<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">8</span>]) <span class="kw">AS</span> val;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: persistent udf (BQ)</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> mydataset.AddFourAndDivide(x INT64, y INT64)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>RETURNS FLOAT64</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> (</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>&nbsp; (x <span class="op">+</span> <span class="dv">4</span>) <span class="op">/</span> y</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>&nbsp; val, mydataset.AddFourAndDivide(val, <span class="dv">2</span>)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>&nbsp; UNNEST([<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">8</span>,<span class="dv">12</span>]) <span class="kw">AS</span> val;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p>Delete persistent udf: <code>DROP FUNCTION &lt;udf_name&gt;</code></p></li>
<li><p>With Scalar subquery (BQ)</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> TEMP <span class="kw">FUNCTION</span> countUserByAge(userAge INT64)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> (</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="dv">1</span>) <span class="kw">FROM</span> users <span class="kw">WHERE</span> age <span class="op">=</span> userAge)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>&nbsp; countUserByAge(<span class="dv">10</span>) <span class="kw">AS</span> count_user_age_10,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>&nbsp; countUserByAge(<span class="dv">20</span>) <span class="kw">AS</span> count_user_age_20,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>&nbsp; countUserByAge(<span class="dv">30</span>) <span class="kw">AS</span> count_user_age_30;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="sec-sql-loops" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-loops">Loops</h2>
<ul>
<li>Misc
<ul>
<li>posgres <a href="https://www.postgresql.org/docs/15/plpgsql-control-structures.html#PLPGSQL-CONTROL-STRUCTURES-LOOPS">docs</a> for loops</li>
</ul></li>
<li>WHILE
<ul>
<li><p><span class="ribbon-highlight">Example</span>: Incrementally add to a counter variable</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Declare the initial value</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span> @counter <span class="dt">INT</span>;</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @counter <span class="op">=</span> <span class="dv">20</span>;</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- Print initial value</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="kw">AS</span> _COUNT;</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- Create a loop</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span>;</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Loop code starting point</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="cf">WHILE</span> @counter <span class="op">&lt;</span> <span class="dv">30</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="op">=</span> @counter <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Loop finish</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- Check the value of the variable</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @counter <span class="kw">AS</span> _COUNT;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li>Cursors (<a href="https://www.postgresql.org/docs/current/plpgsql-cursors.html">Docs</a>)
<ul>
<li><p>Rather than executing a whole query at once, it is possible to set up a cursor that encapsulates the query, and then read the query result a few rows at a time.</p>
<ul>
<li>One reason for doing this is to avoid memory overrun when the result contains a large number of rows. (However, PL/pgSQL users do not normally need to worry about that, since FOR loops automatically use a cursor internally to avoid memory problems.)</li>
<li>A more interesting usage is to return a reference to a cursor that a function has created, allowing the caller to read the rows. This provides an efficient way to return large row sets from functions.</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span> (<a href="https://towardsdatascience.com/5-advanced-sql-techniques-for-real-life-projects-f2db9b6680e2">article</a> (do not pay attention dynamic sql. it’s for embedding sql in C programs))</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DECLARE</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; cur_orders <span class="kw">CURSOR</span> FOR&nbsp;</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">SELECT</span> order_id, product_id, quantity</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">FROM</span> order_details</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">WHERE</span> product_id <span class="op">=</span> <span class="dv">456</span>;</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; product_inventory <span class="dt">INTEGER</span>;</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">OPEN</span> cur_orders;</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="cf">LOOP</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; FETCH cur_orders <span class="kw">INTO</span> order_id, product_id, quantity;</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; EXIT <span class="cf">WHEN</span> <span class="kw">NOT</span> FOUND;</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">SELECT</span> inventory <span class="kw">INTO</span> product_inventory <span class="kw">FROM</span> products <span class="kw">WHERE</span> product_id <span class="op">=</span> <span class="dv">456</span>;</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; product_inventory <span class="op">:=</span> product_inventory <span class="op">-</span> quantity;</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">UPDATE</span> products <span class="kw">SET</span> inventory <span class="op">=</span> product_inventory <span class="kw">WHERE</span> product_id <span class="op">=</span> <span class="dv">456</span>;</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">CLOSE</span> cur_orders;</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="co">-- do something after updating the inventory, such as logging the changes</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>A table called “products” that contains information about all products, including the product ID, product name, and current inventory. You can use a cursor to iterate through all orders that contain a specific product and update its inventory.</li>
<li>A cursor called “cur_orders” that selects all order details that contain a specific product ID. We then define a variable called “product_inventory” to store the current inventory of the product.</li>
<li>Inside the loop, we fetch each order ID, product ID, and quantity from the cursor, subtract the quantity from the current inventory and update the products table with the new inventory value.</li>
<li>Finally, we close the cursor and do something after updating the inventory, such as logging the changes.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-winfun" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-winfun">Window Functions</h2>
<ul>
<li><p>Unlike GROUP BY, keeps original columns after an aggregation<br>
<a href="./_resources/SQL.resources/1-KHkgYYK0Up46b8BunVMYoQ.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="./_resources/SQL.resources/1-KHkgYYK0Up46b8BunVMYoQ.png" class="img-fluid" width="370"></a></p>
<ul>
<li>Allows you to work with both aggregate and non-aggregate values all at once
<ul>
<li>Better performance than using GROUP BY + JOIN to get the same result</li>
</ul></li>
</ul></li>
<li><p>Despite the order of operations, if you really need to have a window function inside a WHERE clause or GROUP BY clause, you may get around this limitation by using a subquery or a WITH query</p>
<ul>
<li><p><span class="ribbon-highlight">Example</span>: Remove duplicate rows</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> temporary_employees <span class="kw">as</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>(SELECT&nbsp;</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>&nbsp; employee_id,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>&nbsp; employee_name,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>&nbsp; department,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> employee_name,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; department,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; employee_id) <span class="kw">as</span> row_count</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_employees)</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> temporary_employees</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> row_count <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p>3 Types of Window Functions<br>
<a href="./_resources/SQL.resources/1-u8SPxze2b1OdCdPo1maVGw.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="./_resources/SQL.resources/1-u8SPxze2b1OdCdPo1maVGw.png" class="img-fluid" width="322"></a></p>
<ul>
<li>LEAD() will give you the row AFTER the row you are finding a value for.</li>
<li>LAG() will give you the row BEFORE the row you are finding a value for.</li>
<li>FIRST_VALUE() returns the first value in an ordered, partitioned data output.</li>
</ul></li>
<li><p>General Syntax<br>
<a href="./_resources/SQL.resources/1-NKUDO4a5fu5kVW-OlkHUJw.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="./_resources/SQL.resources/1-NKUDO4a5fu5kVW-OlkHUJw.png" class="img-fluid" width="440"></a></p>
<ul>
<li>window_function is the name of the window function we want to use (e.g.&nbsp;see above)
<ul>
<li>expression is the name of the column that we want the window function operated on.
<ul>
<li>May not be necessary depending on what window_function is used</li>
</ul></li>
<li>OVER signifies that this is a window function<br>
<a href="_resources/SQL.resources/window-over-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="_resources/SQL.resources/window-over-1.png" class="img-fluid" width="332"></a></li>
</ul></li>
<li>PARTITION BY divides the rows into partitions so we can specify which rows to use to compute the window function
<ul>
<li>partition_list is the name of the column(s) we want to partition by (i.e.&nbsp;group_by)</li>
</ul></li>
<li>ORDER BY is used so that we can order the rows within each partition. This is optional and does not have to be specified
<ul>
<li>order_list is the name of the column(s) we want to order by</li>
</ul></li>
<li>ROWS (optional; typically not used) used to subset the rows <em>within each partition</em>.
<ul>
<li>frame_clause defines how much to offset from our current row</li>
<li>Syntax: ROWS BETWEEN &lt;starting_row&gt; AND &lt;ending_row&gt;
<ul>
<li>Options for starting and ending row
<ul>
<li>UNBOUNDED PRECEDING — all rows before the current row in the partition, i.e.&nbsp;the first row of the partition</li>
<li>[some #] PRECEDING — # of rows before the current row</li>
<li>CURRENT ROW — the current row</li>
<li>[some #] FOLLOWING — # of rows after the current row</li>
<li>UNBOUNDED FOLLOWING — all rows after the current row in the partition, i.e.&nbsp;the last row of the partition</li>
</ul></li>
<li>Examples
<ul>
<li>ROWS BETWEEN 3 PRECEDING AND CURRENT ROW — this means look back the previous 3 rows up to the current row.</li>
<li>ROWS BETWEEN UNBOUNDED PRECEDING AND 1 FOLLOWING — this means look from the first row of the partition to 1 row after the current row</li>
<li>ROWS BETWEEN 5 PRECEDING AND 1 PRECEDING — this means look back the previous 5 rows up to 1 row before the current row</li>
<li>ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING — this means look from the first row of the partition to the last row of the partition</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Average Salary by Job Title<br>
<a href="./_resources/SQL.resources/1-GVX7Ws5Dk_f9-a6o9Wy_kQ.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="./_resources/SQL.resources/1-GVX7Ws5Dk_f9-a6o9Wy_kQ.png" class="img-fluid" width="370"></a><br>
<a href="./_resources/SQL.resources/1-KHkgYYK0Up46b8BunVMYoQ.1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="./_resources/SQL.resources/1-KHkgYYK0Up46b8BunVMYoQ.1.png" class="img-fluid" width="200"></a></p></li>
<li><p><strong>Tables for Examples</strong><br>
<a href="./_resources/SQL.resources/1-vz3DggeLfupObUnYlCa11A.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="./_resources/SQL.resources/1-vz3DggeLfupObUnYlCa11A.png" class="img-fluid" width="279"></a></p></li>
<li><p><span class="ribbon-highlight">Example</span>: Average Unit Price for each CustomerId<br>
<a href="./_resources/SQL.resources/1-c9eFD04nSDvxmzg2zza8oA.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="./_resources/SQL.resources/1-c9eFD04nSDvxmzg2zza8oA.png" class="img-fluid" width="215"></a></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> CustomerId,&nbsp;</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; UnitPrice,&nbsp;</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">AVG</span>(UnitPrice) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> CustomerId) <span class="kw">AS</span> “AvgUnitPrice”</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> [<span class="kw">Order</span>]&nbsp;</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> OrderDetail <span class="kw">ON</span> [<span class="kw">Order</span>].<span class="kw">Id</span> <span class="op">=</span> OrderDetail.OrderId</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: Average Unit Price for each group of CustomerId AND EmployeeId<br>
<a href="./_resources/SQL.resources/1-NEoVEmqBzFSlX3NHNK9dUg.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="./_resources/SQL.resources/1-NEoVEmqBzFSlX3NHNK9dUg.png" class="img-fluid" width="180"></a></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> CustomerId,&nbsp;</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; EmployeeId,&nbsp;</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">AVG</span>(UnitPrice) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> CustomerId, EmployeeId) <span class="kw">AS</span> “AvgUnitPrice”</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> [<span class="kw">Order</span>]&nbsp;</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> OrderDetail <span class="kw">ON</span> [<span class="kw">Order</span>].<span class="kw">Id</span> <span class="op">=</span> OrderDetail.OrderId</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: Create a new column that ranks Unit Price in descending order for each CustomerId<br>
<a href="./_resources/SQL.resources/1-s7wtLz5LVZleovQtIFgQJg.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="./_resources/SQL.resources/1-s7wtLz5LVZleovQtIFgQJg.png" class="img-fluid" width="225"></a></p>
<div class="sourceCode" id="cb75"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> CustomerId,&nbsp;</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; OrderDate,&nbsp;</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; UnitPrice,&nbsp;</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> CustomerId <span class="kw">ORDER</span> <span class="kw">BY</span> UnitPrice <span class="kw">DESC</span>) <span class="kw">AS</span> “UnitRank”</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> [<span class="kw">Order</span>]&nbsp;</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> OrderDetail&nbsp;</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> [<span class="kw">Order</span>].<span class="kw">Id</span> <span class="op">=</span> OrderDetail.OrderId</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Substituting RANK in place of ROW_NUMBER should produce the same results</li>
<li>Note that ranks are skipped (e.g.&nbsp;rank 3 for ALFKI) when there are rows with the same rank
<ul>
<li>If you don’t want ranks skipped, use DENSE_RANK for the window function</li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Create a new column that provides the previous order date’s Quantity for each ProductId<br>
<a href="./_resources/SQL.resources/1-U5Pb6kyZYtMvbhHw13o3YA.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="./_resources/SQL.resources/1-U5Pb6kyZYtMvbhHw13o3YA.png" class="img-fluid" width="257"></a></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> ProductId,&nbsp;</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; OrderDate,&nbsp;</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; Quantity,&nbsp;</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">LAG</span>(Quantity) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> ProductId <span class="kw">ORDER</span> <span class="kw">BY</span> OrderDate) <span class="kw">AS</span> <span class="ot">"LAG"</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> [<span class="kw">Order</span>]&nbsp;</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> OrderDetail <span class="kw">ON</span> [<span class="kw">Order</span>].<span class="kw">Id</span> <span class="op">=</span> OrderDetail.OrderId</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Use LEAD for the <em>following</em> quantity</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Create a new column that provides the very first Quantity ever ordered for each ProductId<br>
<a href="./_resources/SQL.resources/1-crsYDwLQoWTRX1Ilrkwusw.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="./_resources/SQL.resources/1-crsYDwLQoWTRX1Ilrkwusw.png" class="img-fluid" width="213"></a></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> ProductId,&nbsp;</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; OrderDate,&nbsp;</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; Quantity,&nbsp;</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">FIRST_VALUE</span>(Quantity) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> ProductId <span class="kw">ORDER</span> <span class="kw">BY</span> OrderDate) <span class="kw">AS</span> <span class="ot">"FirstValue"</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> [<span class="kw">Order</span>]&nbsp;</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> OrderDetail <span class="kw">ON</span> [<span class="kw">Order</span>].<span class="kw">Id</span> <span class="op">=</span> OrderDetail.OrderId</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: Calculate a cumulative moving average UnitPrice for each CustomerId<br>
<img src="./_resources/SQL.resources/1-FK8pEUSQhqKZv4FGNekZFA.png" class="img-fluid"></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> CustomerId,&nbsp;</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; UnitPrice,&nbsp;</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">AVG</span>(UnitPrice) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> CustomerId&nbsp;</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="kw">ORDER</span> <span class="kw">BY</span> CustomerId&nbsp;</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">CURRENT</span> <span class="kw">ROW</span>) <span class="kw">AS</span> “CumAvg”</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> [<span class="kw">Order</span>]</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> OrderDetail <span class="kw">ON</span> [<span class="kw">Order</span>].<span class="kw">Id</span> <span class="op">=</span> OrderDetail.OrderId</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: Rank customers for each department by amount spent</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; customer_name,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; customer_id,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; amount_spent,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; department_id,</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="fu">RANK</span>(amount_spent) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> amount_spent <span class="kw">DESC</span> <span class="kw">PARTITION</span> <span class="kw">BY</span> department_id) <span class="kw">AS</span> spend_rank</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> employees</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: Find the model and year of car that been on lot the longest</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>SELECT&nbsp;</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">FIRST_VALUE</span>(name) <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> model, <span class="dt">year</span> <span class="kw">ORDER</span> <span class="kw">BY</span> date_at_lot <span class="kw">ASC</span>) <span class="kw">AS</span> oldest_car_name</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>model,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="dt">year</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> cars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><u>Running Totals/Averages (Cumulative Sums)</u></p>
<ul>
<li><p>Uses <code>SUM</code> as the window function</p>
<ul>
<li>Just replace SUM with AVG to get running averages</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span><br>
<a href="./_resources/SQL.resources/1-vZiZM7MBwfeHhi8GP3QrtQ.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23"><img src="./_resources/SQL.resources/1-vZiZM7MBwfeHhi8GP3QrtQ.png" class="img-fluid" width="575"></a></p>
<ul>
<li>Generate a new dataset grouped by month, instead of timestamp. (CTE)
<ul>
<li>Only include three fields: account_id, occurred_month and total_amount_usd</li>
<li>Only computed for the following accounts: 1041 , 1051, 1061, 10141.</li>
</ul></li>
<li>Compute a running total ordered by occurred_month, without collapsing the rows in the result set.
<ul>
<li>Display 2 columns: occurred_month and cum_amnt_usd_by_month<br>
<a href="./_resources/SQL.resources/1-KcELs2mkbYN3XKk0Gzk-jg.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24"><img src="./_resources/SQL.resources/1-KcELs2mkbYN3XKk0Gzk-jg.png" class="img-fluid" width="322"></a><img src="./_resources/SQL.resources/1-2u7h_5kxKinnn15C7VGmiw.png" class="img-fluid"></li>
</ul></li>
<li>Because no partition was specified, the running total is applied on the full dataset and ordered by (ascending) occurred_month</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span> running total by grouping variable</p>
<ul>
<li>Using previous CTE
<ul>
<li>Compute a running total by account_id, ordered by occurred_month, and account_id (i.e.&nbsp;a separate running total for each account_id.)
<ul>
<li>Display 3 columns: account_id, occurred_month, and cum_mon_amnt_usd_by_account<br>
<a href="./_resources/SQL.resources/1-Axkp3Gp-fk5iWysxLJXklg.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25"><img src="./_resources/SQL.resources/1-Axkp3Gp-fk5iWysxLJXklg.png" class="img-fluid" width="685"></a><img src="./_resources/SQL.resources/1-0jfZNXzNQ0jVT_bIW_KpCw.png" class="img-fluid"></li>
</ul></li>
</ul></li>
<li>Same as previous example except a partition column (account_id) is added</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span> Running total over various window lengths</p>
<ul>
<li>Using previous CTE
<ul>
<li>Compute a 3 months rolling running total using a window that includes the current month.</li>
<li>Compute a 7 months rolling running total using a window where the current month is always the middle month.<br>
<img src="./_resources/SQL.resources/1-lbxUJId6dY1fJHz44A1RKQ.png" class="img-fluid"><a href="./_resources/SQL.resources/1-UXXt7TGvkdFFqm-opBx1mg.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26"><img src="./_resources/SQL.resources/1-UXXt7TGvkdFFqm-opBx1mg.png" class="img-fluid" width="775"></a></li>
</ul></li>
<li>First case uses 2 PRECEDING rows and the CURRENT_ROW</li>
<li>Second case uses 3 PRECEDING rows and 3 FOLLOWING rows and the CURRENT_ROW</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Calculate the number consecutive days spent in each country (sqlite)</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span> ordered <span class="kw">as</span> (</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    created,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    country,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lag</span>(country) <span class="kw">over</span> (<span class="kw">order</span> <span class="kw">by</span> created <span class="kw">desc</span>)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">as</span> previous_country</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">from</span> </span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">raw</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>grouped <span class="kw">as</span> (</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">select</span> </span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    country, </span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    created, </span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">filter</span> (</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">where</span> previous_country <span class="kw">is</span> <span class="kw">null</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">or</span> previous_country <span class="op">!=</span> country</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">over</span> (</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">order</span> <span class="kw">by</span> created <span class="kw">desc</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">rows</span> <span class="kw">between</span> <span class="kw">unbounded</span> <span class="kw">preceding</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">and</span> <span class="kw">current</span> <span class="kw">row</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">as</span> grp</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">from</span> </span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>    ordered</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>  country,</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">date</span>(<span class="fu">min</span>(created)) <span class="kw">as</span> <span class="kw">start</span>,</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">date</span>(<span class="fu">max</span>(created)) <span class="kw">as</span> <span class="cf">end</span>,</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cast</span>(</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>    julianday(<span class="dt">date</span>(<span class="fu">max</span>(created))) <span class="op">-</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>    julianday(<span class="dt">date</span>(<span class="fu">min</span>(created))) <span class="kw">as</span> <span class="dt">integer</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">as</span> days</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> </span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>  grouped</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span></span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>  country, grp</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">start</span> <span class="kw">desc</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><a href="https://til.simonwillison.net/sql/consecutive-groups">Post</a></p>
<ul>
<li>Goes over the code and thought process step-by-step with shows original data and results during intermediate steps</li>
</ul></li>
<li><p><a href="https://fosstodon.org/@simon@simonwillison.net/110510148344934383">Thread</a></p>
<ul>
<li>Evidently only sqlite and postgres support filter. Someone in the thread suggest an alternate method.</li>
</ul></li>
<li><p>Output:</p>
<pre><code>country         start         end           days
United Kingdom  2023-06-08  2023-06-08  0
United States   2019-09-02  2023-05-11  1347
France          2019-08-25  2019-08-31  6
Madagascar      2019-07-31  2019-08-07  7
France          2019-07-25  2019-07-25  0
United States   2019-05-04  2019-06-30  57
United Kingdom  2018-08-29  2018-09-10  12
United States   2018-08-05  2018-08-10  5</code></pre></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-ctes" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-ctes">Common Table Expressions (CTE)</h2>
<ul>
<li><p>The result set of a query which exists temporarily and for use only within the context of a larger query. Much like a derived table, the result of a CTE is not stored and exists only for the duration of the query.</p></li>
<li><p>Also see</p>
<ul>
<li><a href="../qmd/sql.html#sec-sql-winfun" style="color: green">Window Functions</a> &gt;&gt; Running Totals &gt;&gt; Examples</li>
<li><a href="../qmd/google-analytics-analysis.html#sec-goog-anal-anal" style="color: green">Google, Google Analytics, Analysis</a> &gt;&gt; Examples 12-15, 18, 19</li>
</ul></li>
<li><p>Use Cases</p>
<ul>
<li>Needing to reference a derived table multiple times in a single query</li>
<li>An alternative to creating a view in the database</li>
<li>Performing the same calculation multiple times over across multiple query components</li>
</ul></li>
<li><p>Improves readability and <em>usually</em> no performance difference</p>
<ul>
<li>Prior to PostgreSQL 12, <a href="https://hakibenita.com/be-careful-with-cte-in-postgre-sql" class="uri">https://hakibenita.com/be-careful-with-cte-in-postgre-sql</a> , something with the caching mechanism created a bottleneck. Currently, version 13 is the latest, so hopefully not a common problem anymore.</li>
</ul></li>
<li><p>Steps</p>
<ul>
<li>Initiate a CTE using “WITH”</li>
<li>Provide a name for the result soon-to-be defined query</li>
<li>After assigning a name, follow with “AS”</li>
<li>Specify column names (optional step)</li>
<li>Define the query to produce the desired result set</li>
<li>If multiple CTEs are required, initiate each subsequent expression with a comma and repeat steps 2-4.</li>
<li>Reference the above-defined CTE(s) in a subsequent query</li>
</ul></li>
<li><p>Syntax</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>expression_name_1 <span class="kw">AS</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>(CTE <span class="kw">query</span> definition <span class="dv">1</span>)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>[, expression_name_X <span class="kw">AS</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>&nbsp; (CTE <span class="kw">query</span> definition X)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>, etc ]</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> expression_A, expression_B, <span class="op">..</span>.</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> expression_name_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span></p>
<ul>
<li><p>Comparison with a “derived” query</p></li>
<li><p>“What is the average monthly cost per campaign for the company’s marketing efforts?”</p></li>
<li><p>Using CTE workflow</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- define CTE:</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> Cost_by_Month <span class="kw">AS</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> campaign_id <span class="kw">AS</span> campaign,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">TO_CHAR</span>(created_date, <span class="st">'YYYY-MM'</span>) <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">SUM</span>(<span class="kw">cost</span>) <span class="kw">AS</span> monthly_cost</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> marketing</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> created_date <span class="kw">BETWEEN</span> NOW() <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">'3 MONTH'</span> <span class="kw">AND</span> NOW()</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- use CTE in subsequent query:</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> campaign, <span class="fu">avg</span>(monthly_cost) <span class="kw">as</span> <span class="ot">"Avg Monthly Cost"</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Cost_by_Month</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> campaign</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> campaign</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Used derived query</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Derived</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> campaign, <span class="fu">avg</span>(monthly_cost) <span class="kw">as</span> <span class="ot">"Avg Monthly Cost"</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="co">-- this is where the derived query is used</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="kw">SELECT</span> campaign_id <span class="kw">AS</span> campaign,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">TO_CHAR</span>(created_date, <span class="st">'YYYY-MM'</span>) <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">SUM</span>(<span class="kw">cost</span>) <span class="kw">AS</span> monthly_cost</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> marketing</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">WHERE</span> created_date <span class="kw">BETWEEN</span> NOW() <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">'3 MONTH'</span> <span class="kw">AND</span> NOW()</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>) <span class="kw">as</span> Cost_By_Month</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> campaign</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> campaign</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span></p>
<ul>
<li>Count the number of interactions of new users</li>
<li>Steps
<ul>
<li>Get new users</li>
<li>Count interactions</li>
<li>Get interactions of new users</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb86"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> new_users <span class="kw">AS</span> (</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span> <span class="kw">id</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> users</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">WHERE</span> created <span class="op">&gt;=</span> <span class="st">'2021-01-01'</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>count_interactions <span class="kw">AS</span> (</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span> <span class="kw">id</span>,</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="fu">COUNT</span>(<span class="op">*</span>) n_interactions</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> interactions</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">id</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>interactions_by_new_users <span class="kw">AS</span> (</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span> <span class="kw">id</span>,</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; n_interactions</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> new_users</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">LEFT</span> <span class="kw">JOIN</span> count_interactions <span class="kw">USING</span> (<span class="kw">id</span>)</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> interactions_by_new_users</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span></p>
<ul>
<li><p>Find the average top Math test score for students in California</p></li>
<li><p>Steps</p>
<ol type="1">
<li>Get a subset of students (California)</li>
<li>Get a subset of test scores (Math)</li>
<li>Join them together to get all Math test scores from California students</li>
<li>Get the top score per student</li>
<li>Take the overall average</li>
</ol></li>
<li><p>Derived Query (i.e.&nbsp;w/o CTE)</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(score)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>FROM&nbsp;</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="kw">SELECT</span> students.<span class="kw">id</span>, <span class="fu">MAX</span>(test_results.score) <span class="kw">as</span> score</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">FROM</span> students&nbsp;</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">JOIN</span> schools <span class="kw">ON</span> (</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; students.school_id <span class="op">=</span> schools.<span class="kw">id</span> <span class="kw">AND</span> schools.state <span class="op">=</span> <span class="st">'CA'</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>&nbsp; )</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">JOIN</span> test_results <span class="kw">ON</span> (</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; students.<span class="kw">id</span> <span class="op">=</span> test_results.student_id</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">AND</span> test_results.subject <span class="op">=</span> <span class="st">'math'</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>&nbsp; )</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">GROUP</span> <span class="kw">BY</span> students.<span class="kw">id</span>) <span class="kw">as</span> tmp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Using CTE</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>&nbsp; student_subset <span class="kw">as</span> (</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span> students.id&nbsp;</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> students&nbsp;</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">JOIN</span> schools <span class="kw">ON</span> (</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; students.school_id <span class="op">=</span> schools.<span class="kw">id</span> <span class="kw">AND</span> schools.state <span class="op">=</span> <span class="st">'CA'</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; )</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>&nbsp; ),</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>&nbsp; score_subset <span class="kw">as</span> (</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span> student_id, score&nbsp;</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> test_results&nbsp;</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">WHERE</span> subject <span class="op">=</span> <span class="st">'math'</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>&nbsp; ),</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>&nbsp; student_scores <span class="kw">as</span> (</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span> student_subset.<span class="kw">id</span>, score_subset.score</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> student_subset&nbsp;</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">JOIN</span> score_subset <span class="kw">ON</span> (</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; student_subset.<span class="kw">id</span> <span class="op">=</span> score_subset.student_id</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; )</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>&nbsp; ),</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>&nbsp; top_score_per_student <span class="kw">as</span> (</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">SELECT</span> <span class="kw">id</span>, <span class="fu">MAX</span>(score) <span class="kw">as</span> score&nbsp;</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> student_scores&nbsp;</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">id</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>&nbsp; )</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(score)&nbsp;</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> top_score_per_student</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-str" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-str">Strings</h2>
<ul>
<li><p>Concatenate</p>
<ul>
<li><p>Also see <a href="../qmd/sql.html#sec-sql-procexp-nulls" style="color: green">Processing Expressions &gt;&gt; NULLs</a></p></li>
<li><p>“||”</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'PostgreSQL'</span> <span class="op">||</span> <span class="st">' '</span> <span class="op">||</span> <span class="st">'Databases'</span> <span class="kw">AS</span> result;</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; result</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co">--------------</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>PostgreSQL Databases</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>CONCAT</code></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">CONCAT</span>(<span class="st">'PostgreSQL'</span>, <span class="st">' '</span>, <span class="st">'Databases'</span>) <span class="kw">AS</span> result;</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; result</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co">--------------</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>PostgreSQL Databases</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>With NULL values</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">CONCAT</span>(<span class="st">'Harry'</span>, <span class="kw">NULL</span>, <span class="st">'Peter'</span>);</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co">--------------</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>HarryPeter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“||” won’t work with NULLs</li>
</ul></li>
<li><p>Columns</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> first_name, last_name,&nbsp;</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">CONCAT</span>(first_name,<span class="st">' '</span> , last_name) <span class="ot">"Full Name"</span>&nbsp;</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> candidates;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>New column, “Full Name”, is created with concatenated columns</li>
</ul></li>
</ul></li>
<li><p>Splitting (BQ)</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>,</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span> <span class="cf">WHEN</span> ARRAY_LENGTH(<span class="kw">SPLIT</span>(page_location, <span class="st">'/'</span>)) <span class="op">&gt;=</span> <span class="dv">5</span>&nbsp;</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">AND</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CONTAINS_SUBSTR(ARRAY_REVERSE(<span class="kw">SPLIT</span>(page_location, <span class="st">'/'</span>))[SAFE_OFFSET(<span class="dv">0</span>)], <span class="st">'+'</span>)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">AND</span> (<span class="fu">LOWER</span>(<span class="kw">SPLIT</span>(page_location, <span class="st">'/'</span>)[SAFE_OFFSET(<span class="dv">4</span>)]) IN&nbsp;</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="st">'accessories'</span>,<span class="st">'apparel'</span>,<span class="st">'brands'</span>,<span class="st">'campus+collection'</span>,<span class="st">'drinkware'</span>,</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'electronics'</span>,<span class="st">'google+redesign'</span>,</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'lifestyle'</span>,<span class="st">'nest'</span>,<span class="st">'new+2015+logo'</span>,<span class="st">'notebooks+journals'</span>,</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'office'</span>,<span class="st">'shop+by+brand'</span>,<span class="st">'small+goods'</span>,<span class="st">'stationery'</span>,<span class="st">'wearables'</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">OR</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="fu">LOWER</span>(<span class="kw">SPLIT</span>(page_location, <span class="st">'/'</span>)[SAFE_OFFSET(<span class="dv">3</span>)]) IN&nbsp;</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="st">'accessories'</span>,<span class="st">'apparel'</span>,<span class="st">'brands'</span>,<span class="st">'campus+collection'</span>,<span class="st">'drinkware'</span>,</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'electronics'</span>,<span class="st">'google+redesign'</span>,</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'lifestyle'</span>,<span class="st">'nest'</span>,<span class="st">'new+2015+logo'</span>,<span class="st">'notebooks+journals'</span>,</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'office'</span>,<span class="st">'shop+by+brand'</span>,<span class="st">'small+goods'</span>,<span class="st">'stationery'</span>,<span class="st">'wearables'</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">THEN</span> <span class="st">'PDP'</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">WHEN</span> <span class="kw">NOT</span>(CONTAINS_SUBSTR(ARRAY_REVERSE(<span class="kw">SPLIT</span>(page_location, <span class="st">'/'</span>))[SAFE_OFFSET(<span class="dv">0</span>)], <span class="st">'+'</span>))</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">AND</span> (<span class="fu">LOWER</span>(<span class="kw">SPLIT</span>(page_location, <span class="st">'/'</span>)[SAFE_OFFSET(<span class="dv">4</span>)]) IN&nbsp;</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;   (<span class="st">'accessories'</span>,<span class="st">'apparel'</span>,<span class="st">'brands'</span>,<span class="st">'campus+collection'</span>,<span class="st">'drinkware'</span>,</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'electronics'</span>,<span class="st">'google+redesign'</span>,</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'lifestyle'</span>,<span class="st">'nest'</span>,<span class="st">'new+2015+logo'</span>,<span class="st">'notebooks+journals'</span>,</span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'office'</span>,<span class="st">'shop+by+brand'</span>,<span class="st">'small+goods'</span>,<span class="st">'stationery'</span>,<span class="st">'wearables'</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OR&nbsp;</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="fu">LOWER</span>(<span class="kw">SPLIT</span>(page_location, <span class="st">'/'</span>)[SAFE_OFFSET(<span class="dv">3</span>)]) IN&nbsp;</span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="st">'accessories'</span>,<span class="st">'apparel'</span>,<span class="st">'brands'</span>,<span class="st">'campus+collection'</span>,<span class="st">'drinkware'</span>,</span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'electronics'</span>,<span class="st">'google+redesign'</span>,</span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'lifestyle'</span>,<span class="st">'nest'</span>,<span class="st">'new+2015+logo'</span>,<span class="st">'notebooks+journals'</span>,</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st">'office'</span>,<span class="st">'shop+by+brand'</span>,<span class="st">'small+goods'</span>,<span class="st">'stationery'</span>,<span class="st">'wearables'</span></span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">THEN</span> <span class="st">'PLP'</span></span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="cf">ELSE</span> page_title</span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="cf">END</span> <span class="kw">AS</span> page_title_adjusted&nbsp;</span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>FROM&nbsp;</span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a>&nbsp; unnested_events</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>From <a href="https://towardsdatascience.com/looking-for-power-user-journeys-in-e-commerce-746f5f68b697">article</a>, <a href="https://gist.github.com/khunreus/17d0f5377bd15b41b2e4956a7166710a">gist</a></li>
<li>Query is creating a new categorical column, “page_title_adjusted,” that is “PDP” when a substring in “page_location” is one of a set of words, and “PLP” when it’s not, and the value of page_title otherwise.</li>
<li>SPLIT splits the string by separator, ‘/’</li>
<li>CONTAINS_SUBSTR is looking for substring with a “+”</li>
<li>[SAFE_OFFSET(3)] pulls the 4th substring (think this indexes by 0?)</li>
<li>After it’s been reversed via ARRAY_REVERSE (?)</li>
<li>ELSE says use the value for page_title when length of the substrings after splitting page_location is 5 or less</li>
<li>“unnested_events” is a CTE</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-arr" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-arr">Arrays</h2>
<ul>
<li><p>Misc</p>
<ul>
<li>PostGres
<ul>
<li>Indexing Arrays starts at 1, not at 0</li>
</ul></li>
</ul></li>
<li><p>Create Array (BQ)</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">ARRAY</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">SELECT</span> <span class="dv">2</span> <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">SELECT</span> <span class="dv">3</span>) <span class="kw">AS</span> new_array;</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>| new_array |</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>| [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>] |</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">-----------+</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="dt">ARRAY</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="kw">SELECT</span> <span class="kw">AS</span> STRUCT <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">SELECT</span> <span class="kw">AS</span> STRUCT <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>) <span class="kw">AS</span> new_array;</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>| new_array&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>| [{<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>}, {<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>}] |</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">------------------------+</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">ARRAY</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="kw">SELECT</span> <span class="kw">AS</span> STRUCT [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>] <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">SELECT</span> <span class="kw">AS</span> STRUCT [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]) <span class="kw">AS</span> new_array;</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------------+</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>| new_array&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------------+</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>| [{[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]}, {[<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]}] |</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">----------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Create a table with Arrays (Postgres)<br>
<a href="./_resources/SQL.resources/image.5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-27"><img src="./_resources/SQL.resources/image.5.png" class="img-fluid" width="300"></a></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> TEMP <span class="kw">TABLE</span> shopping_cart (</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>&nbsp; products text <span class="dt">ARRAY</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>&nbsp; );</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart(products)</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="dt">ARRAY</span>[<span class="st">'product_a'</span>, <span class="st">'product_b'</span>]),</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="dt">ARRAY</span>[<span class="st">'product_c'</span>, <span class="st">'product_d'</span>]),</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="dt">ARRAY</span>[<span class="st">'product_a'</span>, <span class="st">'product_b'</span>, <span class="st">'product_c'</span>]),</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="dt">ARRAY</span>[<span class="st">'product_a'</span>, <span class="st">'product_b'</span>, <span class="st">'product_d'</span>]),</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="dt">ARRAY</span>[<span class="st">'product_b'</span>, <span class="st">'product_d'</span>]);</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- alt syntax w/o ARRAY</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart(products)</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="st">'{"product_a", "product_d"}'</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Also see <a href="../qmd/sql.html#sec-sql-basics" style="color: green">Basics</a> &gt;&gt; Add Data &gt;&gt; Example: chatGPT</li>
</ul></li>
<li><p>Subset an array (postgres)<br>
<a href="./_resources/SQL.resources/image.7.png" class="lightbox" data-gallery="quarto-lightbox-gallery-28"><img src="./_resources/SQL.resources/image.7.png" class="img-fluid" width="220"></a></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>&nbsp; products[<span class="dv">1</span>] <span class="kw">AS</span> first_product <span class="co">-- indexing starts at 1</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Slice an array (postgres)<br>
<a href="./_resources/SQL.resources/image.8.png" class="lightbox" data-gallery="quarto-lightbox-gallery-29"><img src="./_resources/SQL.resources/image.8.png" class="img-fluid" width="236"></a></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id,</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>&nbsp; products [<span class="dv">1</span><span class="ch">:2</span>] <span class="kw">AS</span> first_two_products</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">CARDINALITY</span>(products) <span class="op">&gt;</span> <span class="dv">2</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Unnest an array (postgres)<br>
<a href="./_resources/SQL.resources/image.6.png" class="lightbox" data-gallery="quarto-lightbox-gallery-30"><img src="./_resources/SQL.resources/image.6.png" class="img-fluid" width="208"></a></p>
<div class="sourceCode" id="cb98"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id,</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>&nbsp; UNNEST(products) <span class="kw">AS</span> products</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id <span class="kw">IN</span> (<span class="dv">3</span>, <span class="dv">4</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Useful if you want to perform a join</li>
</ul></li>
<li><p>Filter according to items in arrays (postgres)</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id,</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>&nbsp; products</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="st">'product_c'</span> <span class="op">=</span> <span class="kw">ANY</span> (products);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Only rows with arrays that have “product_c” will be returned</li>
</ul></li>
<li><p>Change array values using <code>UPDATE</code>, <code>SET</code></p>
<div class="sourceCode" id="cb100"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- update arrays&nbsp;</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>&nbsp; products <span class="op">=</span> <span class="dt">ARRAY</span>[<span class="st">'product_a'</span>,<span class="st">'product_b'</span>,<span class="st">'product_e'</span>]</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>UPDATE&nbsp;</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>&nbsp; products[<span class="dv">1</span>] <span class="op">=</span> <span class="st">'product_f'</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id <span class="op">=</span> <span class="dv">2</span>;</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="op">*</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> cart_id;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>First update: all arrays where cart_id == 1 are set to [‘product_a’,‘product_b’,‘product_e’]</p></li>
<li><p>Second update: all array first values where cart_id == 2 are set to ‘product_f’</p></li>
</ul></li>
<li><p>Insert array values</p>
<ul>
<li><p><code>ARRAY_APPEND</code> - puts value at the end of the array</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>&nbsp; products <span class="op">=</span> ARRAY_APPEND(products, <span class="st">'product_x'</span>)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id <span class="op">=</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>arrays in product column where cart_id == 1 get “product_x” appended to the end of their arrays</li>
</ul></li>
<li><p><code>ARRAY_PREPEND</code> - puts value at the beginning of the array</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>UPDATE&nbsp;</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>&nbsp; products <span class="op">=</span> ARRAY_PREPEND(<span class="st">'product_x'</span>, products)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id <span class="op">=</span> <span class="dv">2</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>arrays in product column where cart_id == 2 get “product_x” prepended to the beginning of their arrays</li>
</ul></li>
</ul></li>
<li><p><code>ARRAY_REMOVE</code> - remove array item</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>&nbsp; shopping_cart</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>&nbsp; products <span class="op">=</span> array_remove(products, <span class="st">'product_e'</span>)</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> cart_id <span class="op">=</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>arrays in product column where cart_id == 1 get “product_e” removed from their arrays</li>
</ul></li>
<li><p><code>ARRAY_CONCAT</code>(BQ), <code>ARRAY_CAT</code>(postgres) - Concantenate</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> ARRAY_CONCAT([<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>, <span class="dv">4</span>], [<span class="dv">5</span>, <span class="dv">6</span>]) <span class="kw">as</span> count_to_six;</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------------------------+</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>| count_to_six&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------------------------+</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>| [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------------------------+</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- postgres</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>&nbsp; cart_id,</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>&nbsp; ARRAY_CAT(products, <span class="dt">ARRAY</span>[<span class="st">'promo_product_1'</span>, <span class="st">'promo_product_2'</span>])</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> shopping_cart</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> cart_id;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>ARRAY_TO_STRING</code> - Coerce to string (BQ)</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> items <span class="kw">AS</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="kw">SELECT</span> [<span class="st">'coffee'</span>, <span class="st">'tea'</span>, <span class="st">'milk'</span> ] <span class="kw">as</span> <span class="kw">list</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">SELECT</span> [<span class="st">'cake'</span>, <span class="st">'pie'</span>, <span class="kw">NULL</span>] <span class="kw">as</span> <span class="kw">list</span>)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> ARRAY_TO_STRING(<span class="kw">list</span>, <span class="st">'--'</span>) <span class="kw">AS</span> text</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> items;</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>| text&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>| coffee<span class="co">--tea--milk&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>| cake<span class="co">--pie&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> items <span class="kw">AS</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>&nbsp; (<span class="kw">SELECT</span> [<span class="st">'coffee'</span>, <span class="st">'tea'</span>, <span class="st">'milk'</span> ] <span class="kw">as</span> <span class="kw">list</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">SELECT</span> [<span class="st">'cake'</span>, <span class="st">'pie'</span>, <span class="kw">NULL</span>] <span class="kw">as</span> <span class="kw">list</span>)</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> ARRAY_TO_STRING(<span class="kw">list</span>, <span class="st">'--'</span>, <span class="st">'MISSING'</span>) <span class="kw">AS</span> text</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> items;</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>| text&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+</span></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>| coffee<span class="co">--tea--milk&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>| cake<span class="co">--pie--MISSING&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a><span class="op">+</span><span class="co">--------------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><code>ARRAY_AGG</code> - gather values of a group by variable into an array (<a href="https://docs.snowflake.com/en/sql-reference/functions/array_agg.html">doc</a>)</p>
<ul>
<li><p>Makes the output more readable</p></li>
<li><p><span class="ribbon-highlight">Example</span>: Get categories for each brand</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- without array_agg</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; brand,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">category</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> order_item</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span> brand, <span class="kw">category</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> brand, <span class="kw">category</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>Results:</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>| brand&nbsp; | category&nbsp; |&nbsp;</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>| <span class="co">------ | ---------- |&nbsp;</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>| Arket&nbsp; | jacket&nbsp; &nbsp; |</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>| COS&nbsp; &nbsp; | shirts&nbsp; &nbsp; |</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>| COS&nbsp; &nbsp; | trousers&nbsp; |&nbsp;</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>| COS&nbsp; &nbsp; | vest&nbsp; &nbsp; &nbsp; |</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>| Levi<span class="st">'s | jacket&nbsp; &nbsp; |</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="st">| Levi'</span>s | jeans&nbsp; &nbsp; &nbsp; |</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- with array_agg</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>&nbsp; brand,</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>&nbsp; array_agg(<span class="kw">distinct</span> <span class="kw">category</span>) <span class="kw">as</span> all_categories</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> order_item</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span> brand</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> brand</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>Results:</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>| brand&nbsp; | all_categories&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>| <span class="co">------ | ---------------------------- |&nbsp;</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>| Arket&nbsp; | [<span class="st">'jacket'</span>]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>| COS&nbsp; &nbsp; | [<span class="st">'shirts'</span>,<span class="st">'trousers'</span>,<span class="st">'vest'</span>] |</span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>| Levi<span class="st">'s | ['</span>jacket<span class="st">','</span>jeans<span class="st">']&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a><span class="st">| Uniqlo | ['</span>shirts<span class="st">','</span>t<span class="op">-</span>shirts<span class="st">','</span>vest<span class="st">'] |</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><code>ARRAY_SIZE</code> - function takes an array or a variant as input and returns the number of items within the array/variant (<a href="https://docs.snowflake.com/en/sql-reference/functions/array_size.html">doc</a>)</p>
<ul>
<li><p><span class="ribbon-highlight">Example</span>: How many categories does each brand have?</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>&nbsp; brand,</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>&nbsp; array_agg(<span class="kw">distinct</span> <span class="kw">category</span>) <span class="kw">as</span> all_categories,</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>&nbsp; array_size(all_categories) <span class="kw">as</span> no_of_cat</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> order_item</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span> brand</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> brand</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>Results:</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>| brand&nbsp; | all_categories&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | no_of_cat |</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>| <span class="co">------ | ---------------------------&nbsp; | --------- |</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>| Arket&nbsp; | [<span class="st">'jacket'</span>]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | <span class="dv">1</span>&nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>| COS&nbsp; &nbsp; | [<span class="st">'shirts'</span>,<span class="st">'trousers'</span>,<span class="st">'vest'</span>] | <span class="dv">3</span>&nbsp; &nbsp; &nbsp; &nbsp; |</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>| Levi<span class="st">'s | ['</span>jacket<span class="st">','</span>jeans<span class="st">']&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2&nbsp; &nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="st">| Uniqlo | ['</span>shirts<span class="st">','</span>t<span class="op">-</span>shirts<span class="st">','</span>vest<span class="st">'] | 3&nbsp; &nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a><span class="st">-- postgres using CARDINALITY to get array_size</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a><span class="st">&nbsp; cart_id,</span></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a><span class="st">&nbsp; CARDINALITY(products) AS num_products</span></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a><span class="st">FROM</span></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a><span class="st">&nbsp; shopping_cart;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><code>ARRAY_CONTAINS</code> checks if a <em>variant</em> is included in an array and returns a boolean value. (<a href="https://docs.snowflake.com/en/sql-reference/functions/array_contains.html">doc</a>)</p>
<ul>
<li><p>Variant is just a specific category</p></li>
<li><p>Need to cast the item you’d like to check as a variant first</p></li>
<li><p>Syntax: <code>ARRAY_CONTAINS(variant, array)</code></p></li>
<li><p><span class="ribbon-highlight">Example</span>: What brands have jackets?</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>&nbsp; brand,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>&nbsp; array_agg(<span class="kw">distinct</span> <span class="kw">category</span>) <span class="kw">as</span> all_categories,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>&nbsp; array_size(all_categories) <span class="kw">as</span> no_of_cat,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>&nbsp; array_contains(<span class="st">'jacket'</span>:<span class="ch">:variant</span>,all_categories) <span class="kw">as</span> has_jacket</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> order_item</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span> brand</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> brand</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>Results:</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>| brand&nbsp; | all_categories&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | no_of_cat | has_jacket |</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>| <span class="co">------ | ---------------------------&nbsp; | --------- | ---------- |</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>| Arket&nbsp; | [<span class="st">'jacket'</span>]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | <span class="dv">1</span>&nbsp; &nbsp; &nbsp; &nbsp; | true&nbsp; &nbsp; &nbsp; |</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>| COS&nbsp; &nbsp; | [<span class="st">'shirts'</span>,<span class="st">'trousers'</span>,<span class="st">'vest'</span>] | <span class="dv">3</span>&nbsp; &nbsp; &nbsp; &nbsp; | false&nbsp; &nbsp; &nbsp; |</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>| Levi<span class="st">'s | ['</span>jacket<span class="st">','</span>jeans<span class="st">']&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2&nbsp; &nbsp; &nbsp; &nbsp; | true&nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a><span class="st">| Uniqlo | ['</span>shirts<span class="st">','</span>t<span class="op">-</span>shirts<span class="st">','</span>vest<span class="st">'] | 3&nbsp; &nbsp; &nbsp; &nbsp; | false&nbsp; &nbsp; &nbsp; |</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a><span class="st">-- postgres contains_operator, @&gt;</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="st">&nbsp; cart_id,</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a><span class="st">&nbsp; products</span></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a><span class="st">FROM</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a><span class="st">&nbsp; shopping_cart</span></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a><span class="st">&nbsp; products&nbsp; @&gt; ARRAY['</span>product_a<span class="st">', '</span>product_b<span class="st">'];</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“@&gt;” example returns all rows with arrays containing product_a and product_b</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-bizq" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-bizq">Business Queries</h2>
<ul>
<li><p>Simple Moving Average (SMA)</p>
<ul>
<li><p><span class="ribbon-highlight">Example</span>: 7-day SMA including today</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="dt">Date</span>, Conversions,</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">AVG</span>(Conversions) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">Date</span> <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="dv">6</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">CURRENT</span> <span class="kw">ROW</span>) <span class="kw">as</span> SMA</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> daily_sales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: 3-day SMA not including today</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="dt">date</span>,</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>&nbsp; sales,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">avg</span>(sales) <span class="kw">over</span> (<span class="kw">order</span> <span class="kw">by</span> <span class="dt">date</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">rows</span> <span class="kw">between</span> <span class="dv">3</span> <span class="kw">preceding</span> <span class="kw">and</span> <span class="kw">current</span> <span class="kw">row</span> <span class="op">-</span> <span class="dv">1</span>) <span class="kw">as</span> moving_avg</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> table_daily_sales</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: Rank product categories by shipping cost for each shipping address<br>
<a href="./_resources/SQL.resources/image.png" class="lightbox" data-gallery="quarto-lightbox-gallery-31"><img src="./_resources/SQL.resources/image.png" class="img-fluid" width="450"></a></p>
<div class="sourceCode" id="cb111"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> Product_Category,</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>&nbsp; Shipping_Address,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>&nbsp; Shipping_Cost,</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="kw">PARTITION</span> <span class="kw">BY</span> Product_Category,</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Shipping_Address</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">ORDER</span> <span class="kw">BY</span> Shipping_Cost <span class="kw">DESC</span>) <span class="kw">as</span> RowNumber,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">RANK</span>() OVER&nbsp;</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="kw">PARTITION</span> <span class="kw">BY</span> Product_Category,</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Shipping_Address</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">ORDER</span> <span class="kw">BY</span> Shipping_Cost <span class="kw">DESC</span>) <span class="kw">as</span> RankValues,</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">DENSE_RANK</span>() OVER&nbsp;</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="kw">PARTITION</span> <span class="kw">BY</span> Product_Category,</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Shipping_Address&nbsp;</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">ORDER</span> <span class="kw">BY</span> Shipping_Cost <span class="kw">DESC</span>) <span class="kw">as</span> DenseRankValues</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_Sales_Data_v1</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> Product_Category <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> Shipping_Address <span class="kw">IN</span> (<span class="st">'Germany'</span>,<span class="st">'India'</span>)</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> Status <span class="kw">IN</span> (<span class="st">'Delivered'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>RANK()</code> retrieves ranked rows based on the condition of <code>ORDER BY</code> clause. As you can see there is a tie between 1st two rows i.e.&nbsp;first two rows have same value in Shipping_Cost column (which is mentioned in ORDER BY clause).</li>
<li><code>DENSE_RANK</code> is similar to the <code>RANK</code> , but it does not skip any numbers even if there is a tie between the rows. This you can see in Blue box in the above picture.</li>
<li>Rank resets to 1 when “Shipping_Address” changes location</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Total order quantity for each month</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> strftime(<span class="st">'%m'</span>, OrderDate) <span class="kw">as</span> <span class="dt">Month</span>,</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">SUM</span>(Quantity) <span class="kw">as</span> Total_Quantity</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> Dummy_Sales_Data_v1</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> strftime(<span class="st">'%m'</span>, OrderDate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>strftime</code> extracts the month (%m) from the datetime column, “OrderDate”</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Monthly and yearly number of orders and average shipping costs<br>
<a href="_resources/SQL.resources/proc-ts-avg-rollup-1.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-32"><img src="_resources/SQL.resources/proc-ts-avg-rollup-1.webp" class="img-fluid"></a></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode sqlmysql code-with-copy"><code class="sourceCode sqlmysql"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">EXTRACT</span>(<span class="fu">MONTH</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="fu">month</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(<span class="fu">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="fu">year</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">COUNT</span>(orderid) <span class="kw">AS</span> number_of_orders</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">AVG</span>(shipping_cost) <span class="kw">AS</span> avg_shipping_cost</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> alldata<span class="ch">.</span>salesdata</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">EXTRACT</span>(<span class="fu">MONTH</span> <span class="kw">FROM</span> order_date)</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>       , <span class="fu">EXTRACT</span>(<span class="fu">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">WITH</span> ROLLUP;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>The last row in the above result, where you see <code>NULL</code> in both month and year columns indicates that it shows results for all months in all years i.e.&nbsp;it gives you a total number of orders and average shipping cost in the year 2021.</p></li>
<li><p><code>WITH ROLLUP</code> at the end of the <code>GROUP BY</code> clause says perform <code>COUNT</code> and <code>AVG</code> over the whole year. If there were more than one year, I’m not sure if it would compute the values for each year or for the whole time period though.</p></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Daily counts of open jobs</p>
<ul>
<li>The issue is that there aren’t rows for transactions that remain in a type of holding status
<ul>
<li>e.g.&nbsp;Job Postings website has date columns for the date the job posting was created, the date the job posting went live on the website, and the date the job posting was taken down (action based timestamps), but no dates for the status between “went live” and “taken down”.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb114"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- create a calendar column</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> parse_datetime(<span class="st">'2020–01–01 08:00:00'</span>, <span class="st">'yyyy-MM-dd H:m:s'</span>) <span class="op">+</span> (<span class="dt">interval</span> <span class="st">'1'</span> <span class="dt">day</span> <span class="op">*</span> d) <span class="kw">as</span> cal_date from&nbsp;</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ( <span class="kw">SELECT</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> () <span class="op">-</span><span class="dv">1</span> <span class="kw">as</span> d</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p0,</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p1,</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p2,</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p3,</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p4,</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p5,</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p6,</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p7,</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p8,</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p9,</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="dv">0</span> <span class="kw">as</span> n <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="dv">1</span>) p10</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- left-join your table to the calendar column</span></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="kw">Select</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; c.cal_date,</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="fu">count</span>(<span class="kw">distinct</span> opp_id) <span class="kw">as</span> <span class="ot">"historical_prospects"</span></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a><span class="kw">From</span> calendar c</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a><span class="kw">Left</span> <span class="kw">Join</span></span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; opportunities o</span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">on</span></span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; o.stage_entered ≤ c.cal_date&nbsp;</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">and</span> (o.stage_exited <span class="kw">is</span> <span class="kw">null</span> <span class="kw">or</span> o.stage_exited <span class="op">&gt;</span> c.cal_date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Calendar column should probably be a CTE</li>
<li>Notes from <a href="https://towardsdatascience.com/using-sql-to-calculate-trends-based-on-historical-status-2ee75f23c4e4">Using SQL to calculate trends based on historical status</a></li>
<li>Some flavours of SQL have a <a href="https://www.postgresql.org/docs/current/functions-srf.html">generate_series</a> function, which will create this calendar column for you</li>
<li>For one particular month, then create an indicator column with “if posting_publish_date ≤ 2022–01–01 and (posting_closed_date is null or posting_closed_date &gt; 2022–01–31) then True” and then filter for True and count.</li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Get the latest order from each customer</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Using QUALIFY</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="dt">date</span>,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; customer_id,</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; order_id,</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; price</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> customer_order_table</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>qualify <span class="fu">row_number</span>() <span class="kw">over</span> (<span class="kw">partition</span> <span class="kw">by</span> customer_id <span class="kw">order</span> <span class="kw">by</span> <span class="dt">date</span> <span class="kw">desc</span>) <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- CTE w/window function</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span> order_order <span class="kw">as</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="dt">date</span>,</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; customer_id,</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; order_id,</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; price,</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="fu">row_number</span>() <span class="kw">over</span> (<span class="kw">partition</span> <span class="kw">by</span> customer_id <span class="kw">order</span> <span class="kw">by</span> <span class="dt">date</span> <span class="kw">desc</span>)&nbsp; &nbsp;</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">as</span> order_of_orders</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> customer_order_table&nbsp;</span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="op">*</span></span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> order_order</span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> order_of_orders <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>Results:</span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>| date&nbsp; &nbsp; &nbsp; | customer_id | order_id | price |</span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>|<span class="co">------------|-------------|----------|-------|</span></span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2022</span><span class="op">-</span><span class="dv">01</span><span class="op">-</span><span class="dv">03</span> | <span class="dv">002</span>&nbsp; &nbsp; &nbsp; &nbsp; | <span class="dv">212</span>&nbsp; &nbsp; &nbsp; | <span class="dv">350</span>&nbsp; |</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2022</span><span class="op">-</span><span class="dv">01</span><span class="op">-</span><span class="dv">06</span> | <span class="dv">005</span>&nbsp; &nbsp; &nbsp; &nbsp; | <span class="dv">982</span>&nbsp; &nbsp; &nbsp; | <span class="dv">300</span>&nbsp; |</span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>| <span class="dv">2022</span><span class="op">-</span><span class="dv">01</span><span class="op">-</span><span class="dv">07</span> | <span class="dv">001</span>&nbsp; &nbsp; &nbsp; &nbsp; | <span class="dv">109</span>&nbsp; &nbsp; &nbsp; | <span class="dv">120</span>&nbsp; |</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Medians</p>
<ul>
<li><p>Notes from <a href="https://towardsdatascience.com/how-to-calculate-medians-with-grouping-in-mysql-abb22a3e5097">How to Calculate Medians with Grouping in MySQL</a></p>
<ul>
<li><p>Variables:</p>
<ul>
<li><p>pid: unique id variable</p></li>
<li><p>category: A or B</p></li>
<li><p>price: random value between 1 and 6</p></li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Overall median price</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode sqlpostgresql code-with-copy"><code class="sourceCode sqlpostgresql"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">AVG</span>(sub.price) <span class="kw">AS</span> median</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ( </span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">@</span>row_index <span class="op">:=</span> <span class="op">@</span>row_index <span class="op">+</span> <span class="dv">1</span> <span class="kw">AS</span> row_index, <span class="kw">p</span>.price</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> products.prices <span class="kw">p</span>, (<span class="kw">SELECT</span> <span class="op">@</span>row_index <span class="op">:=</span> <span class="op">-</span><span class="dv">1</span>) r</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> <span class="kw">p</span>.category <span class="op">=</span> <span class="vs">'A</span><span class="st">'</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">p</span>.price </span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> sub</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> sub.row_index <span class="kw">IN</span> (<span class="fu">FLOOR</span>(<span class="op">@</span>row_index <span class="op">/</span> <span class="dv">2</span>), <span class="fu">CEIL</span>(<span class="op">@</span>row_index <span class="op">/</span> <span class="dv">2</span>))</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>median<span class="op">|</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a><span class="co">------+</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>   <span class="fl">3.0</span><span class="op">|</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>@row_index is a SQL variable that is initiated in the <code>FROM</code> statement and updated for each row in the <code>SELECT</code> statement.</p></li>
<li><p>The column whose median will be calculated (the price column in this example) should be sorted. It doesn’t matter if it’s sorted in ascending or descending order.</p></li>
<li><p>According to the definition of median, the median is the value of the middle element (total count is odd) or the average value of the two middle elements (total count is even). In this example, category A has 5 rows and thus the median is the value of the third row after sorting. The values of both <code>FLOOR(@row_index / 2)</code> and <code>CEIL(@row_index / 2)</code> are 2 which is the third row. On the other hand, for category B which has 6 rows, the median is the average value of the third and fourth rows.</p></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Median price for each product</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode sqlmysql code-with-copy"><code class="sourceCode sqlmysql"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    sub2<span class="ch">.</span>category,</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub2<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> sub2<span class="ch">.</span>mid_prices</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>         <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub2<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> (<span class="fu">SUBSTRING_INDEX</span>(sub2<span class="ch">.</span>mid_prices, <span class="st">','</span>, <span class="dv">1</span>) <span class="op">+</span> <span class="fu">SUBSTRING_INDEX</span>(sub2<span class="ch">.</span>mid_prices, <span class="st">','</span>, <span class="op">-</span><span class="dv">1</span>)) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="kw">AS</span> median    </span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> </span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> </span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>            sub1<span class="ch">.</span>category,</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>            sub1<span class="ch">.</span>total,</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>prices, <span class="st">','</span>, CEIL(sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span>)), <span class="st">','</span>, <span class="st">'-1'</span>)</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>prices, <span class="st">','</span>, sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>), <span class="st">','</span>, <span class="st">'-2'</span>)</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">END</span> <span class="kw">AS</span> mid_prices</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> </span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>                <span class="kw">SELECT</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>                    p<span class="ch">.</span>category,</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>                    GROUP_CONCAT(p<span class="ch">.</span>price <span class="kw">ORDER</span> <span class="kw">BY</span> p<span class="ch">.</span>price) <span class="kw">AS</span> prices,</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total</span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">FROM</span> products<span class="ch">.</span>prices p</span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>                <span class="kw">GROUP</span> <span class="kw">BY</span> p<span class="ch">.</span>category</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>            ) sub1</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>    ) sub2</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>category|median|</span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a><span class="co">--------+------+</span></span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>A       |<span class="dv">3</span>     |</span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>B       |<span class="fl">3.5</span>   |</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Breaking down the subqueries</p>
<ul>
<li><p>Sort prices per category</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode sqlmysql code-with-copy"><code class="sourceCode sqlmysql"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    category,</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    GROUP_CONCAT(price <span class="kw">ORDER</span> <span class="kw">BY</span> p<span class="ch">.</span>price) <span class="kw">AS</span> prices,</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> products<span class="ch">.</span>prices p</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> p<span class="ch">.</span>category</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>category|prices     |total|</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a><span class="co">--------+-----------+-----+</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>A       |<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>  |    <span class="dv">5</span>|</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>B       |<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>|    <span class="dv">6</span>|</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>If your table has a lot of data, GROUP_CONCAT would not contain all the data. In this case, you increase the limit for GROUP_CONCAT by: <code>SET GROUP_CONCAT_MAX_LEN = 100000;</code></li>
</ul></li>
<li><p>Get middle prices according to whether the total count is an odd or even number</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode sqlmysql code-with-copy"><code class="sourceCode sqlmysql"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    sub1<span class="ch">.</span>category,</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    sub1<span class="ch">.</span>total,</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>prices, <span class="st">','</span>, CEIL(sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span>)), <span class="st">','</span>, <span class="st">'-1'</span>)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>         <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>prices, <span class="st">','</span>, sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>), <span class="st">','</span>, <span class="st">'-2'</span>)</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="kw">AS</span> mid_prices</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> </span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>            p<span class="ch">.</span>category,</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>            GROUP_CONCAT(p<span class="ch">.</span>price <span class="kw">ORDER</span> <span class="kw">BY</span> p<span class="ch">.</span>price) <span class="kw">AS</span> prices,</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> products<span class="ch">.</span>prices p</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">GROUP</span> <span class="kw">BY</span> p<span class="ch">.</span>category</span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    ) sub1</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>category|total|mid_prices|</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a><span class="co">--------+-----+----------+</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>A       |    <span class="dv">5</span>|<span class="dv">3</span>         |</span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>B       |    <span class="dv">6</span>|<span class="dv">3</span>,<span class="dv">4</span>       |</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>We use the&nbsp;<code>MOD</code>&nbsp;function (modulo) to check if the total count is an odd or even number.</p></li>
<li><p>The&nbsp;<code>SUBSTRING_INDEX</code>&nbsp;function is used twice to extract the middle elements.</p></li>
</ul></li>
</ul></li>
</ul></li>
<li><p><span class="ribbon-highlight">Example</span>: Overall median of price and quantity</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode sqlmysql code-with-copy"><code class="sourceCode sqlmysql"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub2<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> sub2<span class="ch">.</span>mid_prices</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>         <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub2<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> (<span class="fu">SUBSTRING_INDEX</span>(sub2<span class="ch">.</span>mid_prices, <span class="st">','</span>, <span class="dv">1</span>) <span class="op">+</span> <span class="fu">SUBSTRING_INDEX</span>(sub2<span class="ch">.</span>mid_prices, <span class="st">','</span>, <span class="op">-</span><span class="dv">1</span>)) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="kw">AS</span> median_of_price,</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub2<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> sub2<span class="ch">.</span>mid_quantities</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>         <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub2<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> (<span class="fu">SUBSTRING_INDEX</span>(sub2<span class="ch">.</span>mid_quantities, <span class="st">','</span>, <span class="dv">1</span>) <span class="op">+</span> <span class="fu">SUBSTRING_INDEX</span>(sub2<span class="ch">.</span>mid_prices, <span class="st">','</span>, <span class="op">-</span><span class="dv">1</span>)) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="kw">AS</span> median_of_quantity</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> </span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> </span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>            sub1<span class="ch">.</span>total,</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>prices, <span class="st">','</span>, CEIL(sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span>)), <span class="st">','</span>, <span class="st">'-1'</span>)</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>prices, <span class="st">','</span>, sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>), <span class="st">','</span>, <span class="st">'-2'</span>)</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">END</span> <span class="kw">AS</span> mid_prices,</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>quantities, <span class="st">','</span>, CEIL(sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span>)), <span class="st">','</span>, <span class="st">'-1'</span>)</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">WHEN</span> <span class="fu">MOD</span>(sub1<span class="ch">.</span>total, <span class="dv">2</span>) <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="fu">SUBSTRING_INDEX</span>(<span class="fu">SUBSTRING_INDEX</span>(sub1<span class="ch">.</span>quantities, <span class="st">','</span>, sub1<span class="ch">.</span>total<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>), <span class="st">','</span>, <span class="st">'-2'</span>)                 </span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">END</span> <span class="kw">AS</span> mid_quantities</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">FROM</span> </span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">SELECT</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total,</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>                    GROUP_CONCAT(o<span class="ch">.</span>price <span class="kw">ORDER</span> <span class="kw">BY</span> o<span class="ch">.</span>price) <span class="kw">AS</span> prices,</span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>                    GROUP_CONCAT(o<span class="ch">.</span>quantity <span class="kw">ORDER</span> <span class="kw">BY</span> o<span class="ch">.</span>quantity) <span class="kw">AS</span> quantities</span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">FROM</span> products<span class="ch">.</span>orders o</span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>            ) sub1</span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>    ) sub2</span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>median_of_price|median_of_quantity|</span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a><span class="co">---------------+------------------+</span></span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>              |<span class="dv">30</span>                |</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Similar to previous example</p></li>
<li><p>Variables: order_id, price, quantity</p></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-trans" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-trans">Transactions</h2>
<ul>
<li><p>Misc</p>
<ul>
<li>Also see
<ul>
<li><a href="../qmd/sql.html#sec-sql-terms" style="color: green">Terms</a> &gt;&gt; Transaction</li>
<li><a href="../qmd/db-warehouses.html#sec-db-ware-trig" style="color: green">Database, Warehouses &gt;&gt; Database Triggers</a> - Shows how to efficiently transfer data from a transactional database to a warehouse/relational database by setting up event triggers and staging tables.</li>
</ul></li>
<li>When the transaction is successful, COMMIT is applied. When the transaction is aborted, incorrect execution, system failure ROLLBACK occurs.</li>
</ul></li>
<li><p>Only used with INSERT, UPDATE and DELETE</p></li>
<li><p><code>BEGIN TRANSACTION</code>: It indicates the start point of an explicit or local transaction.</p>
<ul>
<li>Represents a point ast which the data referenced by a connection is logically and physically consistent.</li>
<li>If errors are encountered, all data modifications made after the BEGIN TRANSACTION can be rolled back to return the data to this known state of consistency</li>
<li>Syntax: <code>BEGIN TRANSACTION transaction_name ;</code></li>
</ul></li>
<li><p><code>SET TRANSACTION</code>: Places a name on a transaction.</p>
<ul>
<li>Syntax: <code>SET TRANSACTION [ READ WRITE | READ ONLY ];</code></li>
</ul></li>
<li><p><code>COMMIT</code>: used to permanently save the changes done in the transaction in tables/databases. The database cannot regain its previous state after its execution of commit.</p>
<ul>
<li><p>If everything is in order with all statements within a single transaction, all changes are recorded together in the database is called committed. The COMMIT command saves all the transactions to the database since the last COMMIT or ROLLBACK command</p></li>
<li><p><span class="ribbon-highlight">Example</span>: Delete records</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> Student <span class="kw">WHERE</span> AGE <span class="op">=</span> <span class="dv">20</span>;</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Deletes those records from the table which have age = 20 and then commits the changes in the database.</li>
</ul></li>
</ul></li>
<li><p><code>ROLLBACK</code>: used to undo the transactions that have not been saved in the database. The command is only been used to undo changes since the last commit</p>
<ul>
<li>If any error occurs with any of the SQL grouped statements, all changes need to be aborted. The process of reversing changes is called rollback. This command can only be used to undo transactions since the last COMMIT or ROLLBACK command was issued.</li>
<li>Syntax: <code>ROLLBACK;</code></li>
</ul></li>
<li><p><code>SAVEPOINT</code>: creates points within the groups of transactions in which to ROLLBACK.</p>
<ul>
<li><p>Syntax: <code>SAVEPOINT &lt;savepoint_name&gt;;</code></p></li>
<li><p>A savepoint is a point in a transaction in which you can roll the transaction back to a certain point without rolling back the entire transaction.</p></li>
<li><p>Remove a savepoint: <code>RELEASE SAVEPOINT &lt;savepoint_name&gt;</code></p></li>
<li><p><span class="ribbon-highlight">Example</span>: Rollback a deletion</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SAVEPOINT</span> SP1;</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="op">//</span><span class="kw">Savepoint</span> created.</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> Student <span class="kw">WHERE</span> AGE <span class="op">=</span> <span class="dv">20</span>;</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="op">//</span>deleted</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SAVEPOINT</span> SP2;</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a><span class="op">//</span><span class="kw">Savepoint</span> created.</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ROLLBACK</span> <span class="kw">TO</span> SP1;</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="op">//</span><span class="kw">Rollback</span> completed.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-procexp" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-procexp">Processing Expressions</h2>
<ul>
<li><p><u>Use multiple conditions in a WHERE expression</u></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="op">*</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> XXX_table</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> <span class="dv">1</span><span class="op">=</span><span class="dv">1</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="cf">if</span> condition A) <span class="kw">and</span> clause <span class="dv">1</span>&nbsp;</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="cf">if</span> condition B) <span class="kw">and</span> clause <span class="dv">2</span>&nbsp;</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; (<span class="cf">if</span> condition C) <span class="kw">and</span> clause <span class="dv">3</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The “1=1” prevents errors that would occur when the first condition doesn’t apply to any rows.
<ul>
<li>Can also use “true”</li>
</ul></li>
</ul></li>
<li><p><u>Select unique rows without using DISTINCT</u></p>
<ul>
<li><p>Using UNION</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> employee_id,</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; employee_name,</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; department</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_employees</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> employee_id,</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; employee_name,</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; department</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_employees</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>there must be same number and order of columns in both the SELECT statements</li>
</ul></li>
<li><p>Using INTERSECT</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> employee_id,</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; employee_name,</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; department</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_employees</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERSECT</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> employee_id,</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; employee_name,</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; department</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_employees</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>There must be same number and order of columns in both the SELECT statements</li>
</ul></li>
<li><p>Using ROW_NUMBER</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> temporary_employees <span class="kw">as</span> (</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  &nbsp; employee_id,</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  &nbsp; employee_name,</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>  &nbsp; department,</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>  &nbsp; <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> employee_name,</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; department,</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; employee_id) <span class="kw">as</span> row_count</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> Dummy_employees</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> temporary_employees</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> row_count <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Using GROUP BY</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> employee_id,</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; employee_name,</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; department</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_employees</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> employee_id,</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; employee_name,</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; department</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Just need to group by all the columns. Useful to use in conjunction with aggregate functions.</li>
</ul></li>
</ul></li>
<li><p><u>CASE WHEN</u></p>
<div class="sourceCode" id="cb128"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> OrderID,</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; OrderDate,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; Sales_Manager,</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; Quantity,</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="cf">CASE</span> <span class="cf">WHEN</span> Quantity <span class="op">&gt;</span> <span class="dv">51</span> <span class="cf">THEN</span> <span class="st">'High'</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">WHEN</span> Quantity <span class="op">&lt;</span> <span class="dv">51</span> <span class="cf">THEN</span> <span class="st">'Low'</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">ELSE</span> <span class="st">'Medium'</span>&nbsp;</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="cf">END</span> <span class="kw">AS</span> OrderVolume</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_Sales_Data_v1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>END AS</code> specifies the name of the new column, “OrderVolume”</li>
<li><code>ELSE</code> specifies the value when none of the conditions are met
<ul>
<li>If you did not mention ELSE clause and no condition is satisfied, the query will return NULL for that specific record</li>
</ul></li>
</ul></li>
<li><p><u>Pivot Wider</u><br>
<a href="./_resources/SQL.resources/image.1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-33"><img src="./_resources/SQL.resources/image.1.png" class="img-fluid" width="366"></a></p>
<div class="sourceCode" id="cb129"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> Sales_Manager,</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> Shipping_Address <span class="op">=</span> <span class="st">'Singapore'</span> <span class="cf">THEN</span> OrderID</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">END</span>) <span class="kw">AS</span> Singapore_Orders,</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> Shipping_Address <span class="op">=</span> <span class="st">'UK'</span> <span class="cf">THEN</span> OrderID</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">END</span>) <span class="kw">AS</span> UK_Orders,</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> Shipping_Address <span class="op">=</span> <span class="st">'Kenya'</span> <span class="cf">THEN</span> OrderID</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">END</span>) <span class="kw">AS</span> Kenya_Orders,</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">COUNT</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> Shipping_Address <span class="op">=</span> <span class="st">'India'</span> <span class="cf">THEN</span> OrderID</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cf">END</span>) <span class="kw">AS</span> India_Orders</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_Sales_Data_v1</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> Sales_Manager</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Depending on your use-case you can also use different aggregation such as SUM, AVG, MAX, MIN with CASE statement.</li>
</ul></li>
</ul>
<section id="sec-sql-procexp-nulls" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-procexp-nulls">NULLs</h3>
<ul>
<li><p>Division and NULLS</p>
<ul>
<li><p>Any division with NULL values with have a result of NULL.</p></li>
<li><p><code>isNull</code> allows to get a different resulting value</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> IsNull(<span class="op">&lt;</span><span class="kw">column</span><span class="op">&gt;</span>, <span class="dv">0</span>) <span class="op">/</span> <span class="dv">45</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>All NULL values in the column will replaced with 0s during the division operation.</li>
</ul></li>
</ul></li>
<li><p><code>COALESCE</code></p>
<ul>
<li><p>Substitute a default value in place of NULLs</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COALESCE</span>(column_name, <span class="st">'Default Value'</span>) <span class="kw">AS</span> processed_column</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table_name;</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COALESCE</span>(order_date, <span class="fu">current_date</span>) <span class="kw">AS</span> processed_date</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> orders;</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  product <span class="op">||</span><span class="st">' - '</span><span class="op">||</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COALESCE</span>(subcategory, <span class="kw">category</span>, family, <span class="st">'no product description '</span>)</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">AS</span> product_and_subcategory</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> stock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>3rd Expression: If there is a NULL in subcategory, then it looks in category, then into family, and finally if all those fields have NULLs, it uses “no product description” as the value.</li>
</ul></li>
<li><p>Concantenating Strings where NULLs are present</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COALESCE</span>(first_name, <span class="st">''</span>) <span class="op">||</span> <span class="st">' '</span> <span class="op">||</span> <span class="fu">COALESCE</span>(last_name, <span class="st">''</span>) <span class="kw">AS</span> full_name</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> employees;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>NULLs are replaced with an empty string so transformation doesn’t break</li>
</ul></li>
<li><p>Performing calculations involving numeric columns where there are NULLs</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COALESCE</span>(quantity, <span class="dv">0</span>) <span class="op">*</span> <span class="fu">COALESCE</span>(unit_price, <span class="dv">0</span>) <span class="kw">AS</span> total_cost</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> products;</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> product,</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  quantity_available,</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>  minimum_to_have,</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COALESCE</span>(minimum_to_have, quantity_available <span class="op">*</span> <span class="fl">0.5</span>) <span class="kw">AS</span> threshold</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> stock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>NULLs are substituted with 0s so the calcuation doesn’t break</li>
</ul></li>
<li><p>As part of a join in case keys have missing values</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> employees e</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> departments d <span class="kw">ON</span> <span class="fu">COALESCE</span>(e.department_id, <span class="dv">0</span>) <span class="op">=</span> <span class="fu">COALESCE</span>(d.<span class="kw">id</span>, <span class="dv">0</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>With Aggregate Functions</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> department_id, <span class="fu">COALESCE</span>(<span class="fu">SUM</span>(salary), <span class="dv">0</span>) <span class="kw">AS</span> total_salary</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> employees</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> department_id;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Make hierarchical subtotals output more readable</p>
<p><a href="_resources/SQL.resources/coalesce-rollup.png" class="lightbox" data-gallery="quarto-lightbox-gallery-34"><img src="_resources/SQL.resources/coalesce-rollup.png" class="img-fluid" width="432"></a></p>
<div class="sourceCode" id="cb136"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">COALESCE</span>(family,<span class="st">'All Families'</span>) <span class="kw">AS</span> family,</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">COALESCE</span>(<span class="kw">category</span>,<span class="st">'All Categories'</span>) <span class="kw">AS</span> <span class="kw">category</span>,</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">COALESCE</span>(subcategory,<span class="st">'All Subcategories'</span>) <span class="kw">AS</span> subcategory,</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">SUM</span>(quantity_available) <span class="kw">as</span> quantity_in_stock</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> stock</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span>(family, <span class="kw">category</span>, subcategory)</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> family, <span class="kw">category</span>, subcategory</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><code>ROLLUP</code>&nbsp;clause assumes a hierarchy among the columns&nbsp;<code>family</code>,&nbsp;<code>category</code>, and&nbsp;<code>subcategory</code>. Thus, it generates all the grouping sets that make sense considering the hierarchy:&nbsp;<code>GROUP BY family</code>,&nbsp;<code>GROUP BY family, category</code>&nbsp;and&nbsp;<code>GROUP BY family, category, subcategory</code>.</p>
<ul>
<li>This is the reason why&nbsp;<code>ROLLUP</code>&nbsp;is often used to generate subtotals and grand totals for reports.</li>
</ul></li>
<li><p>Without <code>COALESCE</code> , the text in the unused columns for the subtotals would be NULLs.</p></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-procexp-dups" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-procexp-dups">Duplicated Rows</h3>
<ul>
<li><p>Uses <code>QUALIFY</code> as a window function to filter out duplicates</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* removes duplicate rows at the order_id level */</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>QUALIFY <span class="fu">row_number</span>() <span class="kw">over</span> (<span class="kw">partition</span> <span class="kw">by</span> order_id <span class="kw">order</span> <span class="kw">by</span> created_at) <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>More verbose example of what’s happening</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> temporary_employees as&nbsp;</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>(SELECT&nbsp;</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>&nbsp; employee_id,&nbsp;</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>&nbsp; employee_name,&nbsp;</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>&nbsp; department,&nbsp;</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> employee_name,&nbsp;</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; department,&nbsp;</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; employee_id) <span class="kw">as</span> row_count&nbsp;</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> Dummy_employees)</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span>&nbsp;</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> temporary_employees&nbsp;</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> row_count <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p>Use a hash column as id column, then test for duplicates, remove them or investigate them (BigQuery)<br>
<a href="./_resources/SQL.resources/image.3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-35"><img src="./_resources/SQL.resources/image.3.png" class="img-fluid" width="294"></a></p>
<div class="sourceCode" id="cb139"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; inbound_zoo_elephants <span class="kw">AS</span> (</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">FROM</span> flowfunctions.examples.zoo_elephants</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; ),</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; add_row_hash <span class="kw">AS</span> (</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">SELECT</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="op">*</span>,</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TO_HEX(MD5(TO_JSON_STRING(inbound_zoo_elephants))) <span class="kw">AS</span> hex_row_hash</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">FROM</span> inbound_zoo_elephants</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; )</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> records,</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> hex_row_hash) <span class="kw">AS</span> unique_records</span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> add_row_hash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>No duplicate records found, since “records” = 9 and “unique_records” = 9
<ul>
<li>if records &gt; unique_records, duplicates exist</li>
</ul></li>
<li>Can select distinct hex_row_hash if you want to remove duplicates</li>
<li>Can count hex_row_hash then filter where hex_row_hash &gt; 1 to find which rows are duplicates</li>
<li>Notes from <a href="https://towardsdatascience.com/how-to-build-a-unique-md5-row-hash-using-sql-in-bigquery-plus-a-few-related-things-e6f71820f38b">link</a></li>
<li>Description
<ul>
<li>flowfunctions is the project name</li>
<li>examples is a directory (?)</li>
<li>zoo_elephants is the dataset</li>
</ul></li>
<li>Steps
<ul>
<li>TO_JSON_STRING - creates column with json string for each row</li>
<li>MD5 hashes that string</li>
<li>TO_HEX makes it alpha-numeric and gets rid of the symbols in the hash
<ul>
<li>Easier to deal with in BigQuery</li>
<li>Assume this is still unique (?)</li>
</ul></li>
</ul></li>
<li>Note: By adding “true” value, <code>TO_JSON_STRING(inbound_zoo_elephants, true)</code> , TO_JSON_STRING adds line breaks to the json string for easier readability.</li>
<li>Hashing function options
<ul>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hash_functions#md5">MD5</a> -&nbsp; shortest one (16 characters), fine for this use case
<ul>
<li><a href="https://en.wikipedia.org/wiki/MD5">cryptographically broken</a>, returns 16 characters and suffices for our use-case. Other options are</li>
</ul></li>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hash_functions#farm_fingerprint">FARM_FINGERPRINT</a> - returns a signed integer of variable length</li>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hash_functions#sha1">SHA1</a>, <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hash_functions#sha256">SHA256</a> and <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/hash_functions#sha512">SHA512</a>, which return 20, 32 and 64 bytes respectively and are more secure for cryptographic use cases.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-procexp-nest" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-procexp-nest">Nested Data</h3>
<ul>
<li>Recursive CTE
<ul>
<li><p>Recursive CTEs are used primarily when you want to query hierarchical data or graphs. This could be a company’s organizational structure, a family tree, a restaurant menu, or various routes between cities</p></li>
<li><p>Also see</p>
<ul>
<li><a href="https://learnsql.com/blog/sql-recursive-cte/">What Is a Recursive CTE in SQL?</a>
<ul>
<li>Tutorial, 3 examples, and links to other articles</li>
</ul></li>
</ul></li>
<li><p>Syntax</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE cte_name <span class="kw">AS</span> (</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; cte_query_definition (<span class="kw">the</span> anchor <span class="kw">member</span>)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; cte_query_definition (<span class="kw">the</span> recursive <span class="kw">member</span>)</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>FROM&nbsp; cte_name;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><span class="ribbon-highlight">Example</span>: : postgres</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> RECURSIVE category_tree(<span class="kw">id</span>, name, parent_id, <span class="fu">depth</span>, path) <span class="kw">AS</span> (</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">SELECT</span> <span class="kw">id</span>, name, parent_id, <span class="dv">1</span>, <span class="dt">ARRAY</span>[<span class="kw">id</span>]</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">FROM</span> categories</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">WHERE</span> parent_id <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">SELECT</span> categories.<span class="kw">id</span>, categories.name, categories.parent_id, category_tree.<span class="fu">depth</span> <span class="op">+</span> <span class="dv">1</span>, path <span class="op">||</span> categories.<span class="kw">id</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">FROM</span> categories</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">JOIN</span> category_tree <span class="kw">ON</span> categories.parent_id <span class="op">=</span> category_tree.<span class="kw">id</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, name, parent_id, <span class="fu">depth</span>, path</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> category_tree;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>CTE (<code>WITH</code>) + <code>RECURSIVE</code> says it’s a recursive query.</li>
<li><code>UNION ALL</code>combines the results of both statements.
<ul>
<li>Example is defined by 2 Select statements
<ul>
<li>Anchor Member: First SELECT statement selects the root nodes of the category tree (nodes with no parent)
<ul>
<li>Root node is indicated by “parent_id” = NULL</li>
</ul></li>
<li>Recursive member: Second SELECT statement selects the child nodes recursively</li>
</ul></li>
<li>Also see Arrays for further examples of the use of <code>UNION ALL</code></li>
</ul></li>
<li>The “depth” column is used to keep track of the depth of each category node in the tree.
<ul>
<li>“1” in the first statement</li>
<li>“category_tree.depth + 1” in the second statement
<ul>
<li>With every recursion, the CTE will add 1 to the previous depth level, and it will do that until it reaches the end of the hierarchy</li>
</ul></li>
</ul></li>
<li>The “path” column is an array that stores the path from the root to the current node.
<ul>
<li>“ARRAY[id]” in the first statement</li>
<li>“path || categories.id” in the second statement
<ul>
<li>“||” concatenates “path” and “id” columns (See Strings)</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="sec-sql-procexp-bin" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-procexp-bin">Binning</h3>
<ul>
<li><p><code>CASE WHEN</code></p>
<p><a href="_resources/SQL.resources/binning-case-when.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-36"><img src="_resources/SQL.resources/binning-case-when.jpg" class="img-fluid" width="300"></a></p>
<div class="sourceCode" id="cb142"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a> Name, </span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a> Grade,</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a> <span class="cf">CASE</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="op">&lt;</span> <span class="dv">10</span> <span class="cf">THEN</span> <span class="st">'0-9'</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">10</span> <span class="kw">and</span> <span class="dv">19</span> <span class="cf">THEN</span> <span class="st">'10-19'</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">20</span> <span class="kw">and</span> <span class="dv">29</span> <span class="cf">THEN</span> <span class="st">'20-29'</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">30</span> <span class="kw">and</span> <span class="dv">39</span> <span class="cf">THEN</span> <span class="st">'30-39'</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">40</span> <span class="kw">and</span> <span class="dv">49</span> <span class="cf">THEN</span> <span class="st">'40-49'</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">50</span> <span class="kw">and</span> <span class="dv">59</span> <span class="cf">THEN</span> <span class="st">'50-59'</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">60</span> <span class="kw">and</span> <span class="dv">69</span> <span class="cf">THEN</span> <span class="st">'60-69'</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">70</span> <span class="kw">and</span> <span class="dv">79</span> <span class="cf">THEN</span> <span class="st">'70-79'</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">80</span> <span class="kw">and</span> <span class="dv">89</span> <span class="cf">THEN</span> <span class="st">'80-89'</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> Grade <span class="kw">BETWEEN</span> <span class="dv">90</span> <span class="kw">and</span> <span class="dv">99</span> <span class="cf">THEN</span> <span class="st">'90-99'</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> Grade_Bucket</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a> <span class="kw">FROM</span> students</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>BETWEEN</code> is inclusive of the end points</li>
<li>Flexible for any size of bin you need</li>
</ul></li>
<li><p><code>FLOOR</code></p>
<div class="sourceCode" id="cb143"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a> Name,</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a> Grade,</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">FLOOR</span>(Grade <span class="op">/</span> <span class="dv">10</span>) <span class="op">*</span> <span class="dv">10</span> <span class="kw">AS</span> Grade_Bucket</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> students</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Can easily scale up the number of bins without having to increase the lines of code</li>
<li>Only useful for evenly spaced bins</li>
</ul></li>
<li><p><code>LEFT JOIN on preformatted table</code></p>
<div class="sourceCode" id="cb144"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">TABLE</span> bins (</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>    Lower_Bound INT64,</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    Upper_Bound INT64,</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    Grade_Bucket STRING</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> bins (Lower_Bound, Upper_Bound, Grade_Bucket)</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a> (<span class="dv">0</span>, <span class="dv">9</span>, <span class="st">'0-9'</span>)</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a> (<span class="dv">10</span>, <span class="dv">19</span>, <span class="st">'10-19'</span>)</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a> (<span class="dv">20</span>, <span class="dv">29</span>, <span class="st">'20-29'</span>)</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a> (<span class="dv">30</span>, <span class="dv">39</span>, <span class="st">'30-39'</span>)</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a> (<span class="dv">40</span>, <span class="dv">49</span>, <span class="st">'40-49'</span>)</span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a> (<span class="dv">50</span>, <span class="dv">59</span>, <span class="st">'50-59'</span>)</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a> (<span class="dv">60</span>, <span class="dv">69</span>, <span class="st">'60-69'</span>)</span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a> (<span class="dv">70</span>, <span class="dv">79</span>, <span class="st">'70-79'</span>)</span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a> (<span class="dv">80</span>, <span class="dv">89</span>, <span class="st">'80-89'</span>)</span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a> (<span class="dv">90</span>, <span class="dv">99</span>, <span class="st">'90-99'</span>);</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a> A.Name, </span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a> A.Grade,</span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a> B.Grade_Bucket</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> students <span class="kw">AS</span> A</span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> bins <span class="kw">AS</span> B</span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> A.Grade <span class="kw">BETWEEN</span> B.Lower_Bound <span class="kw">AND</span> B.Upper_Bound</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>“bins” table acts a template that funnels the values from your table into the correct bins</li>
</ul></li>
</ul>
</section>
<section id="sec-sql-procexp-ts" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="sec-sql-procexp-ts">Time Series</h3>
<ul>
<li><p><u>All the records between two dates</u></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode sqlmysql code-with-copy"><code class="sourceCode sqlmysql"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> alldata<span class="ch">.</span>salesdata</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dv">1</span><span class="op">=</span><span class="dv">1</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> order_date <span class="kw">BETWEEN</span> <span class="st">'2021-08-01'</span> <span class="kw">AND</span> <span class="st">'2021-08-31'</span>;</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="co">/* without BETWEEN */</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> alldata<span class="ch">.</span>salesdata</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dv">1</span><span class="op">=</span><span class="dv">1</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> order_date <span class="op">&gt;=</span> <span class="st">'2021-08-01'</span> </span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a><span class="kw">AND</span> order_date <span class="op">&lt;=</span> <span class="st">'2021-08-31'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Without BETWEEN is not optimized and therefore, not recommended</li>
</ul></li>
<li><p><u>Extract components from date-time columns</u></p>
<div class="sourceCode" id="cb146"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* MySQL */</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="dt">year</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(<span class="dt">MONTH</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> <span class="dt">month</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(QUARTER <span class="kw">FROM</span> order_date) <span class="kw">AS</span> quarter</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(WEEK <span class="kw">FROM</span> order_date) <span class="kw">AS</span> week_of_year</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(<span class="dt">DAY</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> day_of_month</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(<span class="kw">HOUR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> hour_of_day</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(<span class="kw">MINUTE</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> minute_of_hour</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>    , <span class="fu">EXTRACT</span>(<span class="dt">SECOND</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> second_of_minute</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    , order_date</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> alldata.salesdata;</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a><span class="co">/* SQLte */</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> strftime(<span class="st">'%m'</span>, OrderDate) <span class="kw">as</span> <span class="dt">Month</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>strftime</code> codes<br>
<a href="./_resources/SQL.resources/image.2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-37"><img src="./_resources/SQL.resources/image.2.png" class="img-fluid" width="480"></a></li>
</ul></li>
<li><p><u>Preprocess Time Series with 4 Lags</u> (<a href="https://towardsdatascience.com/concurrently-train-multiple-time-series-models-over-spark-with-xgboost-c6d5ec4a6430">article</a>)</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> top_customers <span class="kw">as</span> (</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="co">--- select the customter ids you want to track</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>transactions <span class="kw">as</span> (</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; SELECT&nbsp;</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; cust_id,&nbsp;</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; dt,&nbsp;</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; date_trunc(<span class="st">'hour'</span>, <span class="fu">cast</span>(event_time <span class="kw">as</span> <span class="dt">timestamp</span>)) <span class="kw">as</span> event_hour,&nbsp;</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">as</span> transactions</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">FROM</span> ourTable</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">WHERE</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; dt <span class="kw">between</span> <span class="fu">cast</span>(date_add(<span class="st">'day'</span>, <span class="op">-</span><span class="dv">7</span>, <span class="fu">current_date</span>) <span class="kw">as</span> <span class="dt">varchar</span>)&nbsp;</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">and</span> <span class="fu">cast</span>(<span class="fu">current_date</span> <span class="kw">as</span> <span class="dt">varchar</span>)</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span> <span class="kw">Order</span> <span class="kw">By</span> event_hour <span class="kw">asc</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> transactions.cust_id,</span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; transactions.event_hour,</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; day_of_week(transactions.event_hour) day_of_week,</span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw">hour</span>(transactions.event_hour) hour_of_day,</span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; transactions.transactions <span class="kw">as</span> transactions,</span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="fu">LAG</span>(transactions,<span class="dv">1</span>) OVER&nbsp;</span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="kw">PARTITION</span> <span class="kw">BY</span> transactions.cust_id <span class="kw">ORDER</span> <span class="kw">BY</span> event_hour) <span class="kw">AS</span> lag1,</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="fu">LAG</span>(transactions,<span class="dv">2</span>) OVER&nbsp;</span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="kw">PARTITION</span> <span class="kw">BY</span> transactions.cust_id <span class="kw">ORDER</span> <span class="kw">BY</span> event_hour) <span class="kw">AS</span> lag2,</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="fu">LAG</span>(transactions,<span class="dv">3</span>) OVER&nbsp;</span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="kw">PARTITION</span> <span class="kw">BY</span> transactions.cust_id <span class="kw">ORDER</span> <span class="kw">BY</span> event_hour) <span class="kw">AS</span> lag3,</span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class="fu">LAG</span>(transactions,<span class="dv">4</span>) OVER&nbsp;</span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="kw">PARTITION</span> <span class="kw">BY</span> transactions.cust_id <span class="kw">ORDER</span> <span class="kw">BY</span> event_hour) <span class="kw">AS</span> lag4</span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> transactions&nbsp;</span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; <span class="kw">join</span> top_customers&nbsp;</span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a>&nbsp; &nbsp; &nbsp; <span class="kw">on</span> transactions.cust_id <span class="op">=</span> top_customers.cust_id</span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-34"><a href="#cb147-34" aria-hidden="true" tabindex="-1"></a><span class="co">/* output */</span></span>
<span id="cb147-35"><a href="#cb147-35" aria-hidden="true" tabindex="-1"></a><span class="ot">"cust_id"</span>, <span class="ot">"event_hour"</span>, <span class="ot">"day_of_week"</span>, <span class="ot">"hour_of_day"</span>, <span class="ot">"transactions"</span>, <span class="ot">"lag1"</span>, <span class="ot">"lag2"</span>, <span class="ot">"lag3"</span>, <span class="ot">"lag4"</span></span>
<span id="cb147-36"><a href="#cb147-36" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 00:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"0"</span>,<span class="ot">"4093"</span>,,,,,,</span>
<span id="cb147-37"><a href="#cb147-37" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 01:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"1"</span>,<span class="ot">"4628"</span>,<span class="ot">"4093"</span>,,,,,</span>
<span id="cb147-38"><a href="#cb147-38" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 02:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"2"</span>,<span class="ot">"5138"</span>,<span class="ot">"4628"</span>,<span class="ot">"4093"</span>,,,,</span>
<span id="cb147-39"><a href="#cb147-39" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 03:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"3"</span>,<span class="ot">"5412"</span>,<span class="ot">"5138"</span>,<span class="ot">"4628"</span>,<span class="ot">"4093"</span>,,,</span>
<span id="cb147-40"><a href="#cb147-40" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 04:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"4"</span>,<span class="ot">"5645"</span>,<span class="ot">"5412"</span>,<span class="ot">"5138"</span>,<span class="ot">"4628"</span>,<span class="ot">"4093"</span>,</span>
<span id="cb147-41"><a href="#cb147-41" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 05:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"5"</span>,<span class="ot">"5676"</span>,<span class="ot">"5645"</span>,<span class="ot">"5412"</span>,<span class="ot">"5138"</span>,<span class="ot">"4628"</span>,</span>
<span id="cb147-42"><a href="#cb147-42" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 06:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"6"</span>,<span class="ot">"6045"</span>,<span class="ot">"5676"</span>,<span class="ot">"5645"</span>,<span class="ot">"5412"</span>,<span class="ot">"5138"</span>,</span>
<span id="cb147-43"><a href="#cb147-43" aria-hidden="true" tabindex="-1"></a><span class="ot">"Customer-123"</span>,<span class="ot">"2023-01-14 07:00:00.000"</span>,<span class="ot">"6"</span>,<span class="ot">"7"</span>,<span class="ot">"6558"</span>,<span class="ot">"6045"</span>,<span class="ot">"5676"</span>,<span class="ot">"5645"</span>,<span class="ot">"5412"</span>,</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Dataset contains number of transactions made per customer per hour.</li>
<li>2 WITH clauses: the first just extracts a list of customers we are interested in. Here you can add any condition that is supposed to filter in or out specific customers (perhaps you want to filter new customers or only include customers with sufficient traffic). The second WITH clause simply creates the first data set — Dataset A, which pulls a week of data for these customers and selects the customer id, date, hour, and number of transactions.</li>
<li>Finally, the last and most important SELECT clause generates Dataset B, by using SQL lag() function on each row in order to capture the number of transactions in each of the hours that preceded the hour in the row.</li>
</ul></li>
</ul>
</section>
</section>
<section id="sec-sql-tools" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-sql-tools">Tools</h2>
<ul>
<li><a href="https://github.com/ademakdogan/ChatSQL">ChatSQL</a>: Convert plain text to MySQL query by ChatGPT</li>
<li><span style="color: goldenrod">{{</span><a href="https://pypi.org/project/sqlglot/" style="color: goldenrod">sqlglot</a><span style="color: goldenrod">}}</span> - no dependency Python SQL parser, transpiler, optimizer, and engine
<ul>
<li><p>Format SQL or translate between nearly twenty different SQL dialects.</p>
<ul>
<li>It doesn’t just transpile active SQL code, too. Moves comments from one dialect to another.</li>
</ul></li>
<li><p>The parser itself can be customized</p></li>
<li><p>Can also help you analyze queries, traverse parsed expression trees, and incrementally (and, programmatically) build SQL queries.</p></li>
<li><p><a href="https://github.com/tobymao/sqlglot/blob/main/sqlglot/optimizer/optimizer.py">support for optimizing SQL queries</a>, and performing <a href="https://github.com/tobymao/sqlglot/blob/main/posts/sql_diff.md">semantic diffs</a>.</p></li>
<li><p>Can be used to <a href="https://github.com/tobymao/sqlglot#sql-execution">unit test queries</a> through mocks based on Python dictionaries.</p></li>
<li><p><span class="ribbon-highlight">Example</span>: : translate duckdb to hive</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>import sqlglot</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>sqlglot.transpile(</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="ot">"SELECT EPOCH_MS(1618088028295)"</span>,&nbsp;</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">read</span> <span class="op">=</span> <span class="ot">"duckdb"</span>,&nbsp;</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>&nbsp; <span class="kw">write</span> <span class="op">=</span> <span class="ot">"hive"</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>)[<span class="dv">0</span>]</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="st">'SELECT FROM_UNIXTIME(1618088028295 / 1000)'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><a href="https://github.com/frectonz/sql-studio">SQL Studio</a> - SQL Database Explorer [SQLite, libSQL, PostgreSQL, MySQL/MariaDB, DuckDB]<br>
<a href="_resources/SQL.resources/tools-sql-studio-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-38"><img src="_resources/SQL.resources/tools-sql-studio-1.png" class="img-fluid" width="532"></a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../qmd/spreadsheets.html" class="pagination-link" aria-label="Spreadsheets">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Spreadsheets</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../qmd/stochastic-processes.html" class="pagination-link" aria-label="Stochastic Processes">
        <span class="nav-page-text">Stochastic Processes</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../LICENSE.html">
<p>Creative Commons Attribution-NonCommercial 4.0 International License</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"openEffect":"zoom","closeEffect":"zoom","loop":false,"descPosition":"bottom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>